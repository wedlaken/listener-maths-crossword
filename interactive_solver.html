<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Crossword Solver</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
        }
        
        .header h1 {
            color: #333;
            margin: 0;
        }
        
        .main-content {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            position: relative;
        }
        
        .grid-section {
            flex: 1;
        }
        
        .info-section {
            flex: 1;
            min-width: 400px;
        }
        
        /* Mobile responsive design */
        @media (max-width: 768px) {
            body {
                margin: 10px;
            }
            
            .container {
                padding: 15px;
                max-width: 100%;
            }
            
            .main-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .grid-section {
                order: 1;
            }
            
            .info-section {
                order: 2;
                min-width: auto;
            }
            
            .crossword-grid {
                max-width: 100%;
                overflow-x: auto;
                display: block;
                margin: 0 auto;
            }
            
            .grid-cell {
                width: 40px;
                height: 40px;
                font-size: 16px;
                box-sizing: border-box;
            }
            
            .cell-value {
                font-size: 18px;
            }
            
            .grid-clue-number {
                font-size: 8px;
            }
            
            .clues-section {
                flex-direction: column;
                gap: 15px;
                width: 100%;
            }
            
            .clues-column {
                margin-bottom: 15px;
                width: 100%;
            }
            
            .clue {
                padding: 10px;
                margin-bottom: 10px;
            }
            
            .clue-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .clue-text {
                font-size: 14px;
            }
            
            .solution-count {
                font-size: 11px;
                min-width: auto;
            }
            
            .solution-dropdown {
                margin-top: 10px;
            }
            
            .solution-select {
                font-size: 14px;
                padding: 8px;
            }
            
            .apply-solution {
                padding: 8px 16px;
                font-size: 14px;
            }
            
            .prime-factor-workpad {
                margin-top: 20px;
                padding: 12px;
            }
            
            .progress-section {
                margin-top: 15px;
                padding: 12px;
            }
            
            .undo-section {
                margin-top: 15px;
                padding: 12px;
            }
            
            .undo-button {
                padding: 10px 20px;
                font-size: 14px;
                margin-bottom: 10px;
            }
            
            .developer-section {
                margin-top: 20px;
                padding: 12px;
                min-height: auto;
            }
            
            .developer-section h3 {
                font-size: 16px;
                margin-bottom: 15px;
            }
            
            .dev-button {
                padding: 8px 12px !important;
                font-size: 11px !important;
                margin-bottom: 8px;
            }
            
            .dev-info {
                font-size: 10px;
                margin-top: 10px;
            }
        }
        
        /* Extra small mobile devices */
        @media (max-width: 480px) {
            .grid-cell {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
            
            .cell-value {
                font-size: 16px;
            }
            
            .grid-clue-number {
                font-size: 7px;
            }
            
            .clue {
                padding: 8px;
            }
            
            .clue-text {
                font-size: 13px;
            }
            
            .solution-count {
                font-size: 10px;
            }
        }
        
        /* Very small mobile devices */
        @media (max-width: 360px) {
            .grid-cell {
                width: 30px;
                height: 30px;
                font-size: 12px;
            }
            
            .cell-value {
                font-size: 14px;
            }
            
            .grid-clue-number {
                font-size: 6px;
            }
            
            .container {
                padding: 10px;
            }
            
            .main-content {
                gap: 15px;
            }
        }
        
        .crossword-grid {
            display: inline-block;
            border: 3px solid #333;
            background-color: #333;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .grid-row {
            display: flex;
        }
        
        .grid-cell {
            width: 50px;
            height: 50px;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            font-weight: bold;
            font-size: 18px;
            box-sizing: border-box;
            border-right: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
        }
        
        .grid-clue-number {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 10px;
            color: #666;
            font-weight: normal;
        }
        
        .cell-value {
            font-size: 20px;
            color: #333;
        }
        
        .grid-cell:nth-child(8n) {
            border-right: none;
        }
        
        .grid-row:last-child .grid-cell {
            border-bottom: none;
        }
        
        .thick-right {
            border-right: 3px solid #333 !important;
        }
        
        .thick-bottom {
            border-bottom: 3px solid #333 !important;
        }
        
        .thick-left {
            border-left: 3px solid #333 !important;
        }
        
        .thick-top {
            border-top: 3px solid #333 !important;
        }
        
        .clues-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .clues-column {
            flex: 1;
        }
        
        .clues-column h3 {
            color: #333;
            border-bottom: 2px solid #333;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        
        .clue {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
            background-color: #f9f9f9;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 2px solid transparent;
        }
        
        .clue:hover {
            background-color: #e9e9e9;
        }
        
        .clue.solved, .anagram-clue.solved {
            background-color: #d4edda !important;
            color: #155724 !important;
            font-weight: bold !important;
        }
        
        .clue.user-selected, .anagram-clue.user-selected {
            background-color: #cce5ff !important;
            color: #004085 !important;
            font-weight: bold !important;
            border-left: 4px solid #007bff !important;
        }
        
        .clue.algorithm-solved, .anagram-clue.algorithm-solved {
            background-color: #d1ecf1 !important;
            color: #0c5460 !important;
            font-weight: bold !important;
            border-left: 4px solid #17a2b8 !important;
        }
        
        .clue.multiple, .anagram-clue.multiple {
            background-color: #fff3cd !important;
            color: #856404 !important;
        }
        
        .clue.unclued, .anagram-clue.unclued {
            background-color: #f8d7da !important;
            color: #721c24 !important;
            font-style: italic !important;
        }
        
        .clue-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .clue-header .clue-number {
            font-weight: normal;
            min-width: 20px;
            color: #888;
            font-size: 13px;
            flex-shrink: 0;
        }
        
        .clue-text {
            flex: 1;
            margin-left: 8px;
            font-weight: bold;
            font-size: 16px;
            color: #222;
        }
        
        .solution-count {
            font-size: 12px;
            color: #666;
            text-align: right;
            flex-shrink: 0;
            min-width: 90px;
        }
        
        .solution-dropdown {
            margin-top: 8px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .solution-select {
            width: 100%;
            padding: 4px;
            margin-bottom: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .solution-text-input {
            width: 100%;
            padding: 4px;
            margin-bottom: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .apply-solution {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .apply-solution:hover {
            background-color: #0056b3;
        }
        
        .apply-solution:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .progress-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        
        .progress-section h3 {
            margin-top: 0;
            color: #333;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }
        
        .progress-stats {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }
        
        .notification {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 400px;
            max-width: 45%;
            padding: 15px;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            text-align: center;
        }
        
        .notification.success {
            background-color: #28a745;
        }
        
        .notification.error {
            background-color: #dc3545;
        }
        
        .notification.info {
            background-color: #17a2b8;
        }
        
        .undo-section {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 6px;
            text-align: center;
        }
        
        .undo-button {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        
        .undo-button:hover {
            background-color: #5a6268;
        }
        
        .undo-button:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
        }
        
        .history-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .constraint-status {
            margin-top: 10px;
            padding: 8px;
            background-color: #fff3cd;
            border-radius: 4px;
            border-left: 4px solid #ffc107;
            font-size: 14px;
            color: #666;
        }
        
        /* Anagram grid styles */
        .anagram-grid {
            border: 3px solid #28a745 !important;
            background-color: white !important;
        }
        .anagram-cell .cell-value {
            color: #333 !important;
        }
        .anagram-clues-section h3 {
            color: #28a745 !important;
            border-bottom: 2px solid #28a745 !important;
            background: none;
        }
        .anagram-clue {
            background-color: #f9f9f9 !important;
            border-left: 4px solid #28a745 !important;
            color: #222 !important;
        }
        
        /* Ensure user-selected anagram clues override the default anagram styling */
        .anagram-clue.user-selected {
            background-color: #cce5ff !important;
            color: #004085 !important;
            font-weight: bold !important;
            border-left: 4px solid #007bff !important;
        }
        .anagram-solutions {
            margin-top: 8px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .anagram-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .anagram-solution {
            background-color: #e9ecef;
            color: #333;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .anagram-more {
            color: #666;
            font-style: italic;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Interactive Crossword Solver</h1>
            <div class="timestamp">Listener 4869, 24 May 2025</div>
        </div>

        <div class="main-content">
            <div class="grid-section">
                <div id="initial-grid-section">
                    <h3>Puzzle Grid</h3>
                    <div class="crossword-grid">
  <div class="grid-row">
    <div class="grid-cell " data-cell="0"><div class="grid-clue-number">1</div></div>
    <div class="grid-cell " data-cell="1"><div class="grid-clue-number">2</div></div>
    <div class="grid-cell " data-cell="2"><div class="grid-clue-number">3</div></div>
    <div class="grid-cell thick-right" data-cell="3"></div>
    <div class="grid-cell " data-cell="4"><div class="grid-clue-number">4</div></div>
    <div class="grid-cell " data-cell="5"><div class="grid-clue-number">5</div></div>
    <div class="grid-cell " data-cell="6"></div>
    <div class="grid-cell " data-cell="7"><div class="grid-clue-number">6</div></div>
  </div>
  <div class="grid-row">
    <div class="grid-cell " data-cell="8"></div>
    <div class="grid-cell thick-right thick-bottom thick-left" data-cell="9"></div>
    <div class="grid-cell " data-cell="10"></div>
    <div class="grid-cell thick-right thick-left thick-top" data-cell="11"><div class="grid-clue-number">7</div></div>
    <div class="grid-cell thick-right thick-top" data-cell="12"><div class="grid-clue-number">8</div></div>
    <div class="grid-cell " data-cell="13"></div>
    <div class="grid-cell thick-bottom thick-left thick-top" data-cell="14"><div class="grid-clue-number">9</div></div>
    <div class="grid-cell " data-cell="15"></div>
  </div>
  <div class="grid-row">
    <div class="grid-cell " data-cell="16"><div class="grid-clue-number">10</div></div>
    <div class="grid-cell " data-cell="17"></div>
    <div class="grid-cell " data-cell="18"></div>
    <div class="grid-cell thick-right" data-cell="19"></div>
    <div class="grid-cell " data-cell="20"><div class="grid-clue-number">11</div></div>
    <div class="grid-cell " data-cell="21"></div>
    <div class="grid-cell " data-cell="22"></div>
    <div class="grid-cell " data-cell="23"></div>
  </div>
  <div class="grid-row">
    <div class="grid-cell thick-bottom" data-cell="24"></div>
    <div class="grid-cell thick-bottom thick-left thick-top" data-cell="25"><div class="grid-clue-number">12</div></div>
    <div class="grid-cell thick-bottom" data-cell="26"></div>
    <div class="grid-cell " data-cell="27"></div>
    <div class="grid-cell " data-cell="28"></div>
    <div class="grid-cell thick-bottom" data-cell="29"></div>
    <div class="grid-cell thick-right thick-bottom thick-top" data-cell="30"></div>
    <div class="grid-cell thick-bottom" data-cell="31"></div>
  </div>
  <div class="grid-row">
    <div class="grid-cell " data-cell="32"><div class="grid-clue-number">13</div></div>
    <div class="grid-cell thick-bottom thick-left" data-cell="33"><div class="grid-clue-number">14</div></div>
    <div class="grid-cell " data-cell="34"><div class="grid-clue-number">15</div></div>
    <div class="grid-cell " data-cell="35"></div>
    <div class="grid-cell " data-cell="36"></div>
    <div class="grid-cell " data-cell="37"><div class="grid-clue-number">16</div></div>
    <div class="grid-cell thick-right thick-bottom" data-cell="38"></div>
    <div class="grid-cell " data-cell="39"><div class="grid-clue-number">17</div></div>
  </div>
  <div class="grid-row">
    <div class="grid-cell " data-cell="40"><div class="grid-clue-number">18</div></div>
    <div class="grid-cell " data-cell="41"></div>
    <div class="grid-cell " data-cell="42"></div>
    <div class="grid-cell thick-right" data-cell="43"></div>
    <div class="grid-cell " data-cell="44"><div class="grid-clue-number">19</div></div>
    <div class="grid-cell " data-cell="45"></div>
    <div class="grid-cell " data-cell="46"></div>
    <div class="grid-cell " data-cell="47"></div>
  </div>
  <div class="grid-row">
    <div class="grid-cell " data-cell="48"><div class="grid-clue-number">20</div></div>
    <div class="grid-cell thick-right thick-bottom thick-top" data-cell="49"></div>
    <div class="grid-cell " data-cell="50"></div>
    <div class="grid-cell thick-right thick-bottom thick-left" data-cell="51"></div>
    <div class="grid-cell thick-right thick-bottom" data-cell="52"></div>
    <div class="grid-cell " data-cell="53"></div>
    <div class="grid-cell thick-right thick-left thick-top" data-cell="54"><div class="grid-clue-number">21</div></div>
    <div class="grid-cell " data-cell="55"></div>
  </div>
  <div class="grid-row">
    <div class="grid-cell " data-cell="56"><div class="grid-clue-number">22</div></div>
    <div class="grid-cell " data-cell="57"></div>
    <div class="grid-cell " data-cell="58"></div>
    <div class="grid-cell thick-right" data-cell="59"></div>
    <div class="grid-cell " data-cell="60"><div class="grid-clue-number">23</div></div>
    <div class="grid-cell " data-cell="61"></div>
    <div class="grid-cell " data-cell="62"></div>
    <div class="grid-cell " data-cell="63"></div>
  </div>
</div>
                </div>
                <div id="anagram-grid-section" style="display: none; margin-top: 30px;">
                    <h3 style="color: #28a745; border-bottom: 2px solid #28a745;">Anagram Grid</h3>
                    <div class="crossword-grid anagram-grid" id="anagram-grid">
  <div class="grid-row">
    <div class="grid-cell anagram-cell " data-cell="0" data-anagram="true"><div class="grid-clue-number">1</div></div>
    <div class="grid-cell anagram-cell " data-cell="1" data-anagram="true"><div class="grid-clue-number">2</div></div>
    <div class="grid-cell anagram-cell " data-cell="2" data-anagram="true"><div class="grid-clue-number">3</div></div>
    <div class="grid-cell anagram-cell thick-right" data-cell="3" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="4" data-anagram="true"><div class="grid-clue-number">4</div></div>
    <div class="grid-cell anagram-cell " data-cell="5" data-anagram="true"><div class="grid-clue-number">5</div></div>
    <div class="grid-cell anagram-cell " data-cell="6" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="7" data-anagram="true"><div class="grid-clue-number">6</div></div>
  </div>
  <div class="grid-row">
    <div class="grid-cell anagram-cell " data-cell="8" data-anagram="true"></div>
    <div class="grid-cell anagram-cell thick-right thick-bottom thick-left" data-cell="9" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="10" data-anagram="true"></div>
    <div class="grid-cell anagram-cell thick-right thick-left thick-top" data-cell="11" data-anagram="true"><div class="grid-clue-number">7</div></div>
    <div class="grid-cell anagram-cell thick-right thick-top" data-cell="12" data-anagram="true"><div class="grid-clue-number">8</div></div>
    <div class="grid-cell anagram-cell " data-cell="13" data-anagram="true"></div>
    <div class="grid-cell anagram-cell thick-bottom thick-left thick-top" data-cell="14" data-anagram="true"><div class="grid-clue-number">9</div></div>
    <div class="grid-cell anagram-cell " data-cell="15" data-anagram="true"></div>
  </div>
  <div class="grid-row">
    <div class="grid-cell anagram-cell " data-cell="16" data-anagram="true"><div class="grid-clue-number">10</div></div>
    <div class="grid-cell anagram-cell " data-cell="17" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="18" data-anagram="true"></div>
    <div class="grid-cell anagram-cell thick-right" data-cell="19" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="20" data-anagram="true"><div class="grid-clue-number">11</div></div>
    <div class="grid-cell anagram-cell " data-cell="21" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="22" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="23" data-anagram="true"></div>
  </div>
  <div class="grid-row">
    <div class="grid-cell anagram-cell thick-bottom" data-cell="24" data-anagram="true"></div>
    <div class="grid-cell anagram-cell thick-bottom thick-left thick-top" data-cell="25" data-anagram="true"><div class="grid-clue-number">12</div></div>
    <div class="grid-cell anagram-cell thick-bottom" data-cell="26" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="27" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="28" data-anagram="true"></div>
    <div class="grid-cell anagram-cell thick-bottom" data-cell="29" data-anagram="true"></div>
    <div class="grid-cell anagram-cell thick-right thick-bottom thick-top" data-cell="30" data-anagram="true"></div>
    <div class="grid-cell anagram-cell thick-bottom" data-cell="31" data-anagram="true"></div>
  </div>
  <div class="grid-row">
    <div class="grid-cell anagram-cell " data-cell="32" data-anagram="true"><div class="grid-clue-number">13</div></div>
    <div class="grid-cell anagram-cell thick-bottom thick-left" data-cell="33" data-anagram="true"><div class="grid-clue-number">14</div></div>
    <div class="grid-cell anagram-cell " data-cell="34" data-anagram="true"><div class="grid-clue-number">15</div></div>
    <div class="grid-cell anagram-cell " data-cell="35" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="36" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="37" data-anagram="true"><div class="grid-clue-number">16</div></div>
    <div class="grid-cell anagram-cell thick-right thick-bottom" data-cell="38" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="39" data-anagram="true"><div class="grid-clue-number">17</div></div>
  </div>
  <div class="grid-row">
    <div class="grid-cell anagram-cell " data-cell="40" data-anagram="true"><div class="grid-clue-number">18</div></div>
    <div class="grid-cell anagram-cell " data-cell="41" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="42" data-anagram="true"></div>
    <div class="grid-cell anagram-cell thick-right" data-cell="43" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="44" data-anagram="true"><div class="grid-clue-number">19</div></div>
    <div class="grid-cell anagram-cell " data-cell="45" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="46" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="47" data-anagram="true"></div>
  </div>
  <div class="grid-row">
    <div class="grid-cell anagram-cell " data-cell="48" data-anagram="true"><div class="grid-clue-number">20</div></div>
    <div class="grid-cell anagram-cell thick-right thick-bottom thick-top" data-cell="49" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="50" data-anagram="true"></div>
    <div class="grid-cell anagram-cell thick-right thick-bottom thick-left" data-cell="51" data-anagram="true"></div>
    <div class="grid-cell anagram-cell thick-right thick-bottom" data-cell="52" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="53" data-anagram="true"></div>
    <div class="grid-cell anagram-cell thick-right thick-left thick-top" data-cell="54" data-anagram="true"><div class="grid-clue-number">21</div></div>
    <div class="grid-cell anagram-cell " data-cell="55" data-anagram="true"></div>
  </div>
  <div class="grid-row">
    <div class="grid-cell anagram-cell " data-cell="56" data-anagram="true"><div class="grid-clue-number">22</div></div>
    <div class="grid-cell anagram-cell " data-cell="57" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="58" data-anagram="true"></div>
    <div class="grid-cell anagram-cell thick-right" data-cell="59" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="60" data-anagram="true"><div class="grid-clue-number">23</div></div>
    <div class="grid-cell anagram-cell " data-cell="61" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="62" data-anagram="true"></div>
    <div class="grid-cell anagram-cell " data-cell="63" data-anagram="true"></div>
  </div>
</div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button id="check-anagram-grid" style="
                            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 25px;
                            font-size: 1.2em;
                            font-weight: bold;
                            cursor: pointer;
                            transition: transform 0.2s;
                            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            âœ… Check Anagram Grid
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="info-section">
                <div id="initial-clues-container">
                    <div class="clues-section">
  <div class="clues-column">
    <h3>Across</h3>
    <div class="clue multiple" data-clue="1_ACROSS" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">1.</span>
        <span class="clue-text">6:2</span>
        <span class="solution-count">5 solutions</span>
      </div>
      <div class="solution-dropdown" id="dropdown-1_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="1_ACROSS">
          <option value="">-- Select a solution --</option>
          <option value="1215">1215</option>
          <option value="2025">2025</option>
          <option value="3375">3375</option>
          <option value="5625">5625</option>
          <option value="9375">9375</option>
        </select>
        <button class="apply-solution" data-clue="1_ACROSS">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="4_ACROSS" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">4.</span>
        <span class="clue-text">3:69</span>
        <span class="solution-count">15 solutions</span>
      </div>
      <div class="solution-dropdown" id="dropdown-4_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="4_ACROSS">
          <option value="">-- Select a solution --</option>
          <option value="6106">6106</option>
          <option value="3266">3266</option>
          <option value="5254">5254</option>
          <option value="7526">7526</option>
          <option value="8378">8378</option>
          <option value="2698">2698</option>
          <option value="9514">9514</option>
          <option value="2414">2414</option>
          <option value="4402">4402</option>
          <option value="6674">6674</option>
          <option value="1846">1846</option>
          <option value="4118">4118</option>
          <option value="8662">8662</option>
          <option value="1562">1562</option>
          <option value="5822">5822</option>
        </select>
        <button class="apply-solution" data-clue="4_ACROSS">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="9_ACROSS" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">9.</span>
        <span class="clue-text">5:1</span>
        <span class="solution-count">2 solutions</span>
      </div>
      <div class="solution-dropdown" id="dropdown-9_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="9_ACROSS">
          <option value="">-- Select a solution --</option>
          <option value="48">48</option>
          <option value="72">72</option>
        </select>
        <button class="apply-solution" data-clue="9_ACROSS">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="10_ACROSS" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">10.</span>
        <span class="clue-text">3:104</span>
        <span class="solution-count">14 solutions</span>
      </div>
      <div class="solution-dropdown" id="dropdown-10_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="10_ACROSS">
          <option value="">-- Select a solution --</option>
          <option value="1605">1605</option>
          <option value="2725">2725</option>
          <option value="3815">3815</option>
          <option value="2247">2247</option>
          <option value="3531">3531</option>
          <option value="5995">5995</option>
          <option value="4173">4173</option>
          <option value="7085">7085</option>
          <option value="5457">5457</option>
          <option value="9265">9265</option>
          <option value="6099">6099</option>
          <option value="7383">7383</option>
          <option value="9309">9309</option>
          <option value="9951">9951</option>
        </select>
        <button class="apply-solution" data-clue="10_ACROSS">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="11_ACROSS" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">11.</span>
        <span class="clue-text">4:11</span>
        <span class="solution-count">9 solutions</span>
      </div>
      <div class="solution-dropdown" id="dropdown-11_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="11_ACROSS">
          <option value="">-- Select a solution --</option>
          <option value="3718">3718</option>
          <option value="3146">3146</option>
          <option value="4394">4394</option>
          <option value="2002">2002</option>
          <option value="1690">1690</option>
          <option value="1430">1430</option>
          <option value="1014">1014</option>
          <option value="1274">1274</option>
          <option value="2366">2366</option>
        </select>
        <button class="apply-solution" data-clue="11_ACROSS">Apply</button>
      </div>
    </div>
    <div class="clue unclued" data-clue="12_ACROSS" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">12.</span>
        <span class="clue-text">Unclued</span>
        <span class="solution-count" id="unclued-count-12_ACROSS"></span>
      </div>
      <div class="solution-input" id="input-12_ACROSS" style="display: none;">
        <input type="text" class="solution-text-input" data-clue="12_ACROSS" placeholder="Enter 6-digit solution" maxlength="6">
        <button class="apply-solution" data-clue="12_ACROSS">Apply</button>
        <span class="unclued-error" id="error-12_ACROSS" style="color: #b00; margin-left: 8px; display: none;"></span>
      </div>
      <div class="solution-dropdown" id="dropdown-12_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="12_ACROSS">
          <option value="">-- Select a solution --</option>
        </select>
        <button class="apply-solution" data-clue="12_ACROSS">Apply</button>
      </div>
    </div>
    <div class="clue unclued" data-clue="14_ACROSS" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">14.</span>
        <span class="clue-text">Unclued</span>
        <span class="solution-count" id="unclued-count-14_ACROSS"></span>
      </div>
      <div class="solution-input" id="input-14_ACROSS" style="display: none;">
        <input type="text" class="solution-text-input" data-clue="14_ACROSS" placeholder="Enter 6-digit solution" maxlength="6">
        <button class="apply-solution" data-clue="14_ACROSS">Apply</button>
        <span class="unclued-error" id="error-14_ACROSS" style="color: #b00; margin-left: 8px; display: none;"></span>
      </div>
      <div class="solution-dropdown" id="dropdown-14_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="14_ACROSS">
          <option value="">-- Select a solution --</option>
        </select>
        <button class="apply-solution" data-clue="14_ACROSS">Apply</button>
      </div>
    </div>
    <div class="clue " data-clue="18_ACROSS" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">18.</span>
        <span class="clue-text">10:0</span>
        <span class="solution-count">1 solution</span>
      </div>
      <div class="solution-dropdown" id="dropdown-18_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="18_ACROSS">
          <option value="">-- Select a solution --</option>
          <option value="1024">1024</option>
        </select>
        <button class="apply-solution" data-clue="18_ACROSS">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="19_ACROSS" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">19.</span>
        <span class="clue-text">7:9</span>
        <span class="solution-count">24 solutions</span>
      </div>
      <div class="solution-dropdown" id="dropdown-19_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="19_ACROSS">
          <option value="">-- Select a solution --</option>
          <option value="8712">8712</option>
          <option value="6160">6160</option>
          <option value="9240">9240</option>
          <option value="1056">1056</option>
          <option value="2464">2464</option>
          <option value="3872">3872</option>
          <option value="5544">5544</option>
          <option value="9900">9900</option>
          <option value="1584">1584</option>
          <option value="4400">4400</option>
          <option value="5808">5808</option>
          <option value="8624">8624</option>
          <option value="5940">5940</option>
          <option value="2376">2376</option>
          <option value="6600">6600</option>
          <option value="8910">8910</option>
          <option value="2640">2640</option>
          <option value="9680">9680</option>
          <option value="1760">1760</option>
          <option value="5346">5346</option>
          <option value="3564">3564</option>
          <option value="3696">3696</option>
          <option value="3960">3960</option>
          <option value="8316">8316</option>
        </select>
        <button class="apply-solution" data-clue="19_ACROSS">Apply</button>
      </div>
    </div>
    <div class="clue " data-clue="20_ACROSS" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">20.</span>
        <span class="clue-text">5:0</span>
        <span class="solution-count">1 solution</span>
      </div>
      <div class="solution-dropdown" id="dropdown-20_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="20_ACROSS">
          <option value="">-- Select a solution --</option>
          <option value="32">32</option>
        </select>
        <button class="apply-solution" data-clue="20_ACROSS">Apply</button>
      </div>
    </div>
    <div class="clue " data-clue="22_ACROSS" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">22.</span>
        <span class="clue-text">2:1427</span>
        <span class="solution-count">1 solution</span>
      </div>
      <div class="solution-dropdown" id="dropdown-22_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="22_ACROSS">
          <option value="">-- Select a solution --</option>
          <option value="2858">2858</option>
        </select>
        <button class="apply-solution" data-clue="22_ACROSS">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="23_ACROSS" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">23.</span>
        <span class="clue-text">6:4</span>
        <span class="solution-count">7 solutions</span>
      </div>
      <div class="solution-dropdown" id="dropdown-23_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="23_ACROSS">
          <option value="">-- Select a solution --</option>
          <option value="3969">3969</option>
          <option value="7875">7875</option>
          <option value="1701">1701</option>
          <option value="9261">9261</option>
          <option value="2835">2835</option>
          <option value="4725">4725</option>
          <option value="6615">6615</option>
        </select>
        <button class="apply-solution" data-clue="23_ACROSS">Apply</button>
      </div>
    </div>
  </div>
  <div class="clues-column">
    <h3>Down</h3>
    <div class="clue multiple" data-clue="1_DOWN" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">1.</span>
        <span class="clue-text">4:16</span>
        <span class="solution-count">20 solutions</span>
      </div>
      <div class="solution-dropdown" id="dropdown-1_DOWN" style="display: none;">
        <select class="solution-select" data-clue="1_DOWN">
          <option value="">-- Select a solution --</option>
          <option value="1425">1425</option>
          <option value="7581">7581</option>
          <option value="9633">9633</option>
          <option value="4389">4389</option>
          <option value="5415">5415</option>
          <option value="1197">1197</option>
          <option value="2223">2223</option>
          <option value="3249">3249</option>
          <option value="3135">3135</option>
          <option value="5187">5187</option>
          <option value="1995">1995</option>
          <option value="7889">7889</option>
          <option value="8151">8151</option>
          <option value="1881">1881</option>
          <option value="2907">2907</option>
          <option value="2793">2793</option>
          <option value="4845">4845</option>
          <option value="6897">6897</option>
          <option value="3705">3705</option>
          <option value="6783">6783</option>
        </select>
        <button class="apply-solution" data-clue="1_DOWN">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="2_DOWN" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">2.</span>
        <span class="clue-text">2:2</span>
        <span class="solution-count">2 solutions</span>
      </div>
      <div class="solution-dropdown" id="dropdown-2_DOWN" style="display: none;">
        <select class="solution-select" data-clue="2_DOWN">
          <option value="">-- Select a solution --</option>
          <option value="35">35</option>
          <option value="15">15</option>
        </select>
        <button class="apply-solution" data-clue="2_DOWN">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="3_DOWN" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">3.</span>
        <span class="clue-text">10:1</span>
        <span class="solution-count">5 solutions</span>
      </div>
      <div class="solution-dropdown" id="dropdown-3_DOWN" style="display: none;">
        <select class="solution-select" data-clue="3_DOWN">
          <option value="">-- Select a solution --</option>
          <option value="1536">1536</option>
          <option value="2304">2304</option>
          <option value="5184">5184</option>
          <option value="7776">7776</option>
          <option value="3456">3456</option>
        </select>
        <button class="apply-solution" data-clue="3_DOWN">Apply</button>
      </div>
    </div>
    <div class="clue " data-clue="5_DOWN" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">5.</span>
        <span class="clue-text">11:0</span>
        <span class="solution-count">1 solution</span>
      </div>
      <div class="solution-dropdown" id="dropdown-5_DOWN" style="display: none;">
        <select class="solution-select" data-clue="5_DOWN">
          <option value="">-- Select a solution --</option>
          <option value="2048">2048</option>
        </select>
        <button class="apply-solution" data-clue="5_DOWN">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="6_DOWN" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">6.</span>
        <span class="clue-text">2:594</span>
        <span class="solution-count">3 solutions</span>
      </div>
      <div class="solution-dropdown" id="dropdown-6_DOWN" style="display: none;">
        <select class="solution-select" data-clue="6_DOWN">
          <option value="">-- Select a solution --</option>
          <option value="2995">2995</option>
          <option value="7891">7891</option>
          <option value="4207">4207</option>
        </select>
        <button class="apply-solution" data-clue="6_DOWN">Apply</button>
      </div>
    </div>
    <div class="clue unclued" data-clue="7_DOWN" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">7.</span>
        <span class="clue-text">Unclued</span>
        <span class="solution-count" id="unclued-count-7_DOWN"></span>
      </div>
      <div class="solution-input" id="input-7_DOWN" style="display: none;">
        <input type="text" class="solution-text-input" data-clue="7_DOWN" placeholder="Enter 6-digit solution" maxlength="6">
        <button class="apply-solution" data-clue="7_DOWN">Apply</button>
        <span class="unclued-error" id="error-7_DOWN" style="color: #b00; margin-left: 8px; display: none;"></span>
      </div>
      <div class="solution-dropdown" id="dropdown-7_DOWN" style="display: none;">
        <select class="solution-select" data-clue="7_DOWN">
          <option value="">-- Select a solution --</option>
        </select>
        <button class="apply-solution" data-clue="7_DOWN">Apply</button>
      </div>
    </div>
    <div class="clue unclued" data-clue="8_DOWN" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">8.</span>
        <span class="clue-text">Unclued</span>
        <span class="solution-count" id="unclued-count-8_DOWN"></span>
      </div>
      <div class="solution-input" id="input-8_DOWN" style="display: none;">
        <input type="text" class="solution-text-input" data-clue="8_DOWN" placeholder="Enter 6-digit solution" maxlength="6">
        <button class="apply-solution" data-clue="8_DOWN">Apply</button>
        <span class="unclued-error" id="error-8_DOWN" style="color: #b00; margin-left: 8px; display: none;"></span>
      </div>
      <div class="solution-dropdown" id="dropdown-8_DOWN" style="display: none;">
        <select class="solution-select" data-clue="8_DOWN">
          <option value="">-- Select a solution --</option>
        </select>
        <button class="apply-solution" data-clue="8_DOWN">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="13_DOWN" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">13.</span>
        <span class="clue-text">3:1281</span>
        <span class="solution-count">2 solutions</span>
      </div>
      <div class="solution-dropdown" id="dropdown-13_DOWN" style="display: none;">
        <select class="solution-select" data-clue="13_DOWN">
          <option value="">-- Select a solution --</option>
          <option value="7698">7698</option>
          <option value="5132">5132</option>
        </select>
        <button class="apply-solution" data-clue="13_DOWN">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="15_DOWN" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">15.</span>
        <span class="clue-text">4:8</span>
        <span class="solution-count">15 solutions</span>
      </div>
      <div class="solution-dropdown" id="dropdown-15_DOWN" style="display: none;">
        <select class="solution-select" data-clue="15_DOWN">
          <option value="">-- Select a solution --</option>
          <option value="1089">1089</option>
          <option value="4225">4225</option>
          <option value="1155">1155</option>
          <option value="2275">2275</option>
          <option value="3575">3575</option>
          <option value="2541">2541</option>
          <option value="5005">5005</option>
          <option value="9295">9295</option>
          <option value="1617">1617</option>
          <option value="3185">3185</option>
          <option value="7865">7865</option>
          <option value="1815">1815</option>
          <option value="1625">1625</option>
          <option value="3993">3993</option>
          <option value="5915">5915</option>
        </select>
        <button class="apply-solution" data-clue="15_DOWN">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="16_DOWN" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">16.</span>
        <span class="clue-text">4:29</span>
        <span class="solution-count">32 solutions</span>
      </div>
      <div class="solution-dropdown" id="dropdown-16_DOWN" style="display: none;">
        <select class="solution-select" data-clue="16_DOWN">
          <option value="">-- Select a solution --</option>
          <option value="5890">5890</option>
          <option value="3844">3844</option>
          <option value="5766">5766</option>
          <option value="5642">5642</option>
          <option value="9610">9610</option>
          <option value="3596">3596</option>
          <option value="1550">1550</option>
          <option value="5394">5394</option>
          <option value="1302">1302</option>
          <option value="5270">5270</option>
          <option value="8990">8990</option>
          <option value="8866">8866</option>
          <option value="2852">2852</option>
          <option value="4774">4774</option>
          <option value="9982">9982</option>
          <option value="2356">2356</option>
          <option value="4278">4278</option>
          <option value="8246">8246</option>
          <option value="2108">2108</option>
          <option value="4030">4030</option>
          <option value="1612">1612</option>
          <option value="3534">3534</option>
          <option value="7502">7502</option>
          <option value="3410">3410</option>
          <option value="7378">7378</option>
          <option value="1364">1364</option>
          <option value="3162">3162</option>
          <option value="7130">7130</option>
          <option value="3038">3038</option>
          <option value="2418">2418</option>
          <option value="2170">2170</option>
          <option value="2046">2046</option>
        </select>
        <button class="apply-solution" data-clue="16_DOWN">Apply</button>
      </div>
    </div>
    <div class="clue " data-clue="17_DOWN" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">17.</span>
        <span class="clue-text">4:0</span>
        <span class="solution-count">1 solution</span>
      </div>
      <div class="solution-dropdown" id="dropdown-17_DOWN" style="display: none;">
        <select class="solution-select" data-clue="17_DOWN">
          <option value="">-- Select a solution --</option>
          <option value="2401">2401</option>
        </select>
        <button class="apply-solution" data-clue="17_DOWN">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="21_DOWN" data-grid-type="initial">
      <div class="clue-header">
        <span class="clue-number">21.</span>
        <span class="clue-text">4:0</span>
        <span class="solution-count">2 solutions</span>
      </div>
      <div class="solution-dropdown" id="dropdown-21_DOWN" style="display: none;">
        <select class="solution-select" data-clue="21_DOWN">
          <option value="">-- Select a solution --</option>
          <option value="16">16</option>
          <option value="81">81</option>
        </select>
        <button class="apply-solution" data-clue="21_DOWN">Apply</button>
      </div>
    </div>
  </div>
</div>
                </div>
                <div id="anagram-clues-container" style="display: none;">
                    <div class="clues-section anagram-clues-section" id="anagram-clues-section">
                        <div class="clues-column">
                            <h3>Anagram Solutions - Across</h3>
                            <div id="anagram-across-clues">
                                <p style="color: #666; font-style: italic;">Complete the initial grid to generate anagram solutions</p>
                            </div>
                        </div>
                        <div class="clues-column">
                            <h3>Anagram Solutions - Down</h3>
                            <div id="anagram-down-clues">
                                <p style="color: #666; font-style: italic;">Complete the initial grid to generate anagram solutions</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="prime-factor-workpad" style="margin-top: 15px; padding: 15px; background-color: #f8f9fa; border-radius: 6px; border: 2px solid #dee2e6;">
                    <h3 style="margin-top: 0; color: #495057; border-bottom: 2px solid #6c757d; padding-bottom: 8px;">ðŸ”¢ Prime Factor Workpad</h3>
                    <div style="margin-bottom: 15px;">
                        <label for="workpad-number" style="display: block; margin-bottom: 5px; font-weight: bold; color: #495057;">Enter a number to factorize:</label>
                        <input type="number" id="workpad-number" placeholder="e.g., 142857" style="
                            width: 100%;
                            padding: 8px;
                            border: 1px solid #ced4da;
                            border-radius: 4px;
                            font-size: 14px;
                            margin-bottom: 10px;
                        ">
                        <button id="factorize-btn" style="
                            background-color: #007bff;
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 14px;
                            margin-right: 10px;
                        ">Factorize</button>
                        <button id="clear-workpad" style="
                            background-color: #6c757d;
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 14px;
                        ">Clear</button>
                    </div>
                    <div id="factorization-result" style="
                        background-color: white;
                        border: 1px solid #dee2e6;
                        border-radius: 4px;
                        padding: 12px;
                        min-height: 30px;
                        font-family: 'Courier New', monospace;
                        font-size: 14px;
                        color: #495057;
                    ">
                        <div style="color: #6c757d; font-style: italic;">Enter a number above to see its prime factorization</div>
                    </div>
                    <div id="factorization-stats" style="
                        margin-top: 10px;
                        padding: 8px;
                        background-color: #e9ecef;
                        border-radius: 4px;
                        font-size: 12px;
                        color: #495057;
                        display: none;
                    "></div>
                </div>
                
                <div class="progress-section">
                    <h3>Progress</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="progress-stats">
                        <div>Cells filled: 0/64 (0.0%)</div>
                        <div>Clues solved: 0/24</div>
                    </div>

                </div>
                <div class="undo-section">
                    <h3>Solution History</h3>
                    <button class="undo-button" id="undo-button" disabled>Undo Last Solution</button>
                    <div class="history-info" id="history-info">No solutions applied yet</div>
                </div>
                <div class="developer-section" style="margin-top: 15px; padding: 15px; background-color: #e9ecef; border-radius: 6px; text-align: center; min-height: 140px;">
                    <h3>Developer Tools</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 10px;">
                        <button class="dev-button" id="dev-fill-14a" style="
                            background-color: #28a745;
                            color: white;
                            border: none;
                            padding: 6px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 12px;
                            white-space: nowrap;
                        ">Fill 14A</button>
                        <button class="dev-button" id="dev-fill-complete" style="
                            background-color: #dc3545;
                            color: white;
                            border: none;
                            padding: 6px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 12px;
                            white-space: nowrap;
                        ">Fill Initial</button>
                        <button class="dev-button" id="dev-fill-anagram" style="
                            background-color: #ffc107;
                            color: white;
                            border: none;
                            padding: 6px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 12px;
                            white-space: nowrap;
                            display: none;
                        ">Fill Anagram</button>
                        <button class="dev-button" id="dev-toggle-anagram" style="
                            background-color: #17a2b8;
                            color: white;
                            border: none;
                            padding: 6px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 12px;
                            white-space: nowrap;
                        ">Toggle Anagram</button>
                        <button class="dev-button" id="dev-toggle-constraints" style="
                            background-color: #6f42c1;
                            color: white;
                            border: none;
                            padding: 6px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 12px;
                            white-space: nowrap;
                        ">Toggle Constraints</button>
                    </div>
                    <div class="dev-info" style="font-size: 11px; color: #666;">Use these buttons to quickly test the anagram grid</div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Interactive functionality
        let solvedCells = {};
        let anagramSolvedCells = {};  // Separate state for anagram grid
        let clueObjects = {"1_ACROSS": {"number": 1, "direction": "ACROSS", "cell_indices": [0, 1, 2, 3], "length": 4, "is_unclued": false, "possible_solutions": [1215, 2025, 3375, 5625, 9375], "original_solution_count": 5}, "1_DOWN": {"number": 1, "direction": "DOWN", "cell_indices": [0, 8, 16, 24], "length": 4, "is_unclued": false, "possible_solutions": [1425, 7581, 9633, 4389, 5415, 1197, 2223, 3249, 3135, 5187, 1995, 7889, 8151, 1881, 2907, 2793, 4845, 6897, 3705, 6783], "original_solution_count": 20}, "2_DOWN": {"number": 2, "direction": "DOWN", "cell_indices": [1, 9], "length": 2, "is_unclued": false, "possible_solutions": [35, 15], "original_solution_count": 2}, "3_DOWN": {"number": 3, "direction": "DOWN", "cell_indices": [2, 10, 18, 26], "length": 4, "is_unclued": false, "possible_solutions": [1536, 2304, 5184, 7776, 3456], "original_solution_count": 5}, "4_ACROSS": {"number": 4, "direction": "ACROSS", "cell_indices": [4, 5, 6, 7], "length": 4, "is_unclued": false, "possible_solutions": [6106, 3266, 5254, 7526, 8378, 2698, 9514, 2414, 4402, 6674, 1846, 4118, 8662, 1562, 5822], "original_solution_count": 15}, "5_DOWN": {"number": 5, "direction": "DOWN", "cell_indices": [5, 13, 21, 29], "length": 4, "is_unclued": false, "possible_solutions": [2048], "original_solution_count": 1}, "6_DOWN": {"number": 6, "direction": "DOWN", "cell_indices": [7, 15, 23, 31], "length": 4, "is_unclued": false, "possible_solutions": [2995, 7891, 4207], "original_solution_count": 3}, "7_DOWN": {"number": 7, "direction": "DOWN", "cell_indices": [11, 19, 27, 35, 43, 51], "length": 6, "is_unclued": true, "possible_solutions": [], "original_solution_count": 0}, "8_DOWN": {"number": 8, "direction": "DOWN", "cell_indices": [12, 20, 28, 36, 44, 52], "length": 6, "is_unclued": true, "possible_solutions": [], "original_solution_count": 0}, "9_ACROSS": {"number": 9, "direction": "ACROSS", "cell_indices": [14, 15], "length": 2, "is_unclued": false, "possible_solutions": [48, 72], "original_solution_count": 2}, "10_ACROSS": {"number": 10, "direction": "ACROSS", "cell_indices": [16, 17, 18, 19], "length": 4, "is_unclued": false, "possible_solutions": [1605, 2725, 3815, 2247, 3531, 5995, 4173, 7085, 5457, 9265, 6099, 7383, 9309, 9951], "original_solution_count": 14}, "11_ACROSS": {"number": 11, "direction": "ACROSS", "cell_indices": [20, 21, 22, 23], "length": 4, "is_unclued": false, "possible_solutions": [3718, 3146, 4394, 2002, 1690, 1430, 1014, 1274, 2366], "original_solution_count": 9}, "12_ACROSS": {"number": 12, "direction": "ACROSS", "cell_indices": [25, 26, 27, 28, 29, 30], "length": 6, "is_unclued": true, "possible_solutions": [], "original_solution_count": 0}, "13_DOWN": {"number": 13, "direction": "DOWN", "cell_indices": [32, 40, 48, 56], "length": 4, "is_unclued": false, "possible_solutions": [7698, 5132], "original_solution_count": 2}, "14_ACROSS": {"number": 14, "direction": "ACROSS", "cell_indices": [33, 34, 35, 36, 37, 38], "length": 6, "is_unclued": true, "possible_solutions": [], "original_solution_count": 0}, "15_DOWN": {"number": 15, "direction": "DOWN", "cell_indices": [34, 42, 50, 58], "length": 4, "is_unclued": false, "possible_solutions": [1089, 4225, 1155, 2275, 3575, 2541, 5005, 9295, 1617, 3185, 7865, 1815, 1625, 3993, 5915], "original_solution_count": 15}, "16_DOWN": {"number": 16, "direction": "DOWN", "cell_indices": [37, 45, 53, 61], "length": 4, "is_unclued": false, "possible_solutions": [5890, 3844, 5766, 5642, 9610, 3596, 1550, 5394, 1302, 5270, 8990, 8866, 2852, 4774, 9982, 2356, 4278, 8246, 2108, 4030, 1612, 3534, 7502, 3410, 7378, 1364, 3162, 7130, 3038, 2418, 2170, 2046], "original_solution_count": 32}, "17_DOWN": {"number": 17, "direction": "DOWN", "cell_indices": [39, 47, 55, 63], "length": 4, "is_unclued": false, "possible_solutions": [2401], "original_solution_count": 1}, "18_ACROSS": {"number": 18, "direction": "ACROSS", "cell_indices": [40, 41, 42, 43], "length": 4, "is_unclued": false, "possible_solutions": [1024], "original_solution_count": 1}, "19_ACROSS": {"number": 19, "direction": "ACROSS", "cell_indices": [44, 45, 46, 47], "length": 4, "is_unclued": false, "possible_solutions": [8712, 6160, 9240, 1056, 2464, 3872, 5544, 9900, 1584, 4400, 5808, 8624, 5940, 2376, 6600, 8910, 2640, 9680, 1760, 5346, 3564, 3696, 3960, 8316], "original_solution_count": 24}, "20_ACROSS": {"number": 20, "direction": "ACROSS", "cell_indices": [48, 49], "length": 2, "is_unclued": false, "possible_solutions": [32], "original_solution_count": 1}, "21_DOWN": {"number": 21, "direction": "DOWN", "cell_indices": [54, 62], "length": 2, "is_unclued": false, "possible_solutions": [16, 81], "original_solution_count": 2}, "22_ACROSS": {"number": 22, "direction": "ACROSS", "cell_indices": [56, 57, 58, 59], "length": 4, "is_unclued": false, "possible_solutions": [2858], "original_solution_count": 1}, "23_ACROSS": {"number": 23, "direction": "ACROSS", "cell_indices": [60, 61, 62, 63], "length": 4, "is_unclued": false, "possible_solutions": [3969, 7875, 1701, 9261, 2835, 4725, 6615], "original_solution_count": 7}};
        let anagramClueObjects = {};
        let solverStatus = {"solved_cells": 0, "solved_clues": 0, "min_required_cells": 0, "can_enter_unclued": true, "constraint_message": "", "total_candidates": 0, "available_factors": []};
        let minRequiredCells = 0;
        let userSelectedSolutions = new Set();
        let anagramUserSelectedSolutions = new Set();  // Separate tracking for anagram solutions
        let originalSolutionCounts = {};
        let originalSolutions = {};
        let anagramConstraintsEnabled = true;  // Global flag to control constraint level
        for (const [clueId, clue] of Object.entries(clueObjects)) {
            originalSolutionCounts[clueId] = clue.possible_solutions.length;
            originalSolutions[clueId] = [...clue.possible_solutions];
        }
        let solutionHistory = [];
        let undoButton = null;
        let historyInfo = null;
        function saveState(clueId, solution) {
            // Determine if this is an anagram solution
            const isAnagramSolution = clueId.startsWith('anagram_');
            
            const state = {
                timestamp: new Date().toLocaleTimeString(),
                clueId: clueId,
                solution: solution,
                isAnagramSolution: isAnagramSolution,
                solvedCells: {...solvedCells},
                clueObjects: JSON.parse(JSON.stringify(clueObjects)),
                userSelectedSolutions: new Set(userSelectedSolutions),
                // Add anagram state to the saved state
                anagramSolvedCells: {...anagramSolvedCells},
                anagramClueObjects: JSON.parse(JSON.stringify(anagramClueObjects)),
                anagramUserSelectedSolutions: new Set(anagramUserSelectedSolutions)
            };
            solutionHistory.push(state);
            updateUndoButton();
            console.log('Saved state:', state);
        }
        function undoLastSolution() {
            if (solutionHistory.length === 0) return;
            const lastState = solutionHistory.pop();
            console.log('Undoing solution:', lastState);
            
            // Restore initial grid state
            solvedCells = {...lastState.solvedCells};
            clueObjects = JSON.parse(JSON.stringify(lastState.clueObjects));
            userSelectedSolutions = new Set(lastState.userSelectedSolutions);
            
            // Restore anagram grid state (if it exists in the saved state)
            if (lastState.anagramSolvedCells) {
                anagramSolvedCells = {...lastState.anagramSolvedCells};
            }
            if (lastState.anagramClueObjects) {
                anagramClueObjects = JSON.parse(JSON.stringify(lastState.anagramClueObjects));
            }
            if (lastState.anagramUserSelectedSolutions) {
                anagramUserSelectedSolutions = new Set(lastState.anagramUserSelectedSolutions);
            }
            
            // Update displays
            updateGridDisplay();
            updateAllClueDisplays();
            
            // Update anagram grid display if anagram state exists
            if (lastState.anagramSolvedCells && Object.keys(lastState.anagramSolvedCells).length > 0) {
                updateAnagramGridDisplay();
                updateAnagramClueDisplays();
            }
            
            updateProgress();
            updateUndoButton();
            
            if (lastState.solution === 'DESELECT') {
                showNotification(`Undid deselect for clue ${lastState.clueId}`, 'info');
            } else {
                const gridType = lastState.isAnagramSolution ? 'anagram grid' : 'initial grid';
                showNotification(`Undid solution "${lastState.solution}" for clue ${lastState.clueId} (${gridType})`, 'info');
            }
        }
        function updateUndoButton() {
            if (!undoButton) return;
            const canUndo = solutionHistory.length > 0;
            undoButton.disabled = !canUndo;
            if (canUndo) {
                const lastState = solutionHistory[solutionHistory.length - 1];
                if (lastState.solution === 'DESELECT') {
                    historyInfo.textContent = `Last action: Deselected clue ${lastState.clueId} at ${lastState.timestamp}`;
                } else {
                    const gridType = lastState.isAnagramSolution ? 'anagram' : 'initial';
                    historyInfo.textContent = `Last solution: ${lastState.solution} for ${lastState.clueId} (${gridType}) at ${lastState.timestamp}`;
                }
            } else {
                historyInfo.textContent = 'No solutions applied yet';
            }
        }
        function updateGridDisplay() {
            document.querySelectorAll('.cell-value').forEach(el => {
                el.remove();
            });
            for (const [cellIndex, digit] of Object.entries(solvedCells)) {
                updateCellDisplay(parseInt(cellIndex), digit);
            }
        }
        
        function updateAnagramGridDisplay() {
            // Clear all anagram cell values
            document.querySelectorAll('[data-anagram="true"] .cell-value').forEach(el => {
                el.remove();
            });
            // Update anagram grid with current anagramSolvedCells
            for (const [cellIndex, digit] of Object.entries(anagramSolvedCells)) {
                updateAnagramCellDisplay(parseInt(cellIndex), digit);
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up event listeners');
            window.solvingStartTime = Date.now();
            undoButton = document.getElementById('undo-button');
            historyInfo = document.getElementById('history-info');
            updateUndoButton();
            undoButton.addEventListener('click', undoLastSolution);
            document.getElementById('dev-fill-14a').addEventListener('click', fill14A);
            document.getElementById('dev-fill-complete').addEventListener('click', fillCompleteGrid);
            document.getElementById('dev-fill-anagram').addEventListener('click', fillAnagramGrid);
            document.getElementById('dev-toggle-anagram').addEventListener('click', toggleAnagramMode);
            document.getElementById('dev-toggle-constraints').addEventListener('click', toggleConstraints);
            document.getElementById('factorize-btn').addEventListener('click', factorizeNumber);
            document.getElementById('clear-workpad').addEventListener('click', clearWorkpad);
            document.getElementById('workpad-number').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    factorizeNumber();
                }
            });
            
            // Show intro modal
            showIntroModal();
            
            // Add event listener for the anagram check button
            const checkAnagramBtn = document.getElementById('check-anagram-grid');
            if (checkAnagramBtn) {
                checkAnagramBtn.addEventListener('click', function() {
                    // Check if all anagram clues are solved
                    let allSolved = true;
                    for (const clue of Object.values(anagramClueObjects)) {
                        if (!clue.possible_solutions || clue.possible_solutions.length !== 1) {
                            allSolved = false;
                            break;
                        }
                    }
                    if (allSolved && Object.keys(anagramClueObjects).length > 0) {
                        showAnagramCompletionCelebration();
                    } else {
                        showNotification('Not all anagram clues are solved yet!', 'error');
                    }
                });
            }
            // Unified event handler for both initial and anagram clues
            document.addEventListener('click', function(e) {
                const clueDiv = e.target.closest('.clue');
                if (!clueDiv) return;
                if (e.target.closest('.solution-dropdown') || e.target.closest('.solution-input') || e.target.closest('.deselect-dialog') || e.target.classList.contains('apply-solution') || e.target.classList.contains('deselect-solution')) {
                    return;
                }
                
                const clueId = clueDiv.getAttribute('data-clue');
                const gridType = clueDiv.getAttribute('data-grid-type');
                console.log('Clue clicked:', clueId, 'grid type:', gridType);
                
                // Check if this clue has a user-selected solution (either initial or anagram)
                if (userSelectedSolutions.has(clueId) || anagramUserSelectedSolutions.has(clueId)) {
                    showDeselectDialog(clueId);
                    return;
                }
                
                const dropdownDiv = document.getElementById(`dropdown-${clueId}`);
                const inputDiv = document.getElementById(`input-${clueId}`);
                
                // Hide all other dropdowns/inputs first
                document.querySelectorAll('.solution-dropdown, .solution-input, .deselect-dialog').forEach(d => {
                    if (d !== dropdownDiv && d !== inputDiv) d.style.display = 'none';
                });
                
                if (gridType === 'anagram') {
                    // Handle anagram clues - always show dropdown if it exists
                    if (dropdownDiv) {
                        const isHidden = dropdownDiv.style.display === 'none' || dropdownDiv.style.display === '';
                        dropdownDiv.style.display = isHidden ? 'block' : 'none';
                        console.log('Toggled anagram dropdown for', clueId, 'to', isHidden ? 'visible' : 'hidden');
                    } else {
                        console.log('No dropdown found for anagram clue:', clueId);
                    }
                } else {
                    // Handle initial clues (existing logic)
                    const clue = clueObjects[clueId];
                    if (clue && clue.is_unclued) {
                        // Handle unclued clues
                        if (dropdownDiv && inputDiv) {
                            const candidates = getFilteredCandidatesForClue(clueId);
                            const candidateCount = candidates.length;
                            
                            // Hide both initially
                            dropdownDiv.style.display = 'none';
                            inputDiv.style.display = 'none';
                            
                            // Show appropriate interface based on candidate count
                            if (candidateCount <= 50) {
                                // Show dropdown with candidates
                                const select = dropdownDiv.querySelector('select');
                                if (select) {
                                    select.innerHTML = '<option value="">-- Select a solution --</option>';
                                    for (const candidate of candidates) {
                                        const opt = document.createElement('option');
                                        opt.value = candidate;
                                        opt.textContent = candidate.toString().padStart(clue.length, '0');
                                        select.appendChild(opt);
                                    }
                                }
                                dropdownDiv.style.display = 'block';
                                console.log('Showing dropdown for', clueId, 'with', candidateCount, 'candidates');
                            } else {
                                // Show input box for manual entry
                                inputDiv.style.display = 'block';
                                console.log('Showing input box for', clueId, 'with', candidateCount, 'candidates');
                            }
                        }
                    } else {
                        // Handle clued clues - show dropdown if it exists
                        if (dropdownDiv) {
                            const isHidden = dropdownDiv.style.display === 'none' || dropdownDiv.style.display === '';
                            dropdownDiv.style.display = isHidden ? 'block' : 'none';
                            console.log('Toggled dropdown for', clueId, 'to', isHidden ? 'visible' : 'hidden');
                        }
                    }
                }
            });
            // Unified apply button handler for both grid types
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('apply-solution')) {
                    e.stopPropagation();
                    const clueId = e.target.getAttribute('data-clue');
                    console.log('Apply button clicked for:', clueId);
                    const select = e.target.parentNode.querySelector('.solution-select');
                    const input = e.target.parentNode.querySelector('.solution-text-input');
                    let solution = '';
                    if (select) {
                        solution = select.value;
                        console.log('Selected solution from dropdown:', solution);
                    } else if (input) {
                        solution = input.value;
                        console.log('Entered solution from input:', solution);
                    }
                    if (solution) {
                        applySolutionToGrid(clueId, solution);
                    } else {
                        showNotification('Please select or enter a solution first', 'error');
                    }
                }
            });
        });

        function updateCellDisplay(cellIndex, digit) {
            const cell = document.querySelector(`[data-cell="${cellIndex}"]`);
            if (cell) {
                let valueElement = cell.querySelector('.cell-value');
                if (!valueElement) {
                    // Create the cell-value element if it doesn't exist
                    valueElement = document.createElement('div');
                    valueElement.className = 'cell-value';
                    cell.appendChild(valueElement);
                }
                valueElement.textContent = digit;
            }
        }

        function updateAnagramCellDisplay(cellIndex, digit) {
            const cell = document.querySelector(`[data-cell="${cellIndex}"][data-anagram="true"]`);
            if (cell) {
                let valueElement = cell.querySelector('.cell-value');
                if (!valueElement) {
                    // Create the cell-value element if it doesn't exist
                    valueElement = document.createElement('div');
                    valueElement.className = 'cell-value';
                    cell.appendChild(valueElement);
                }
                valueElement.textContent = digit;
            }
        }

        function canEnterUncluedSolution(clueId) {
            const clue = clueObjects[clueId];
            if (!clue || !clue.is_unclued) {
                return { allowed: false, reason: 'Not an unclued clue' };
            }
            
            // No constraint - allow entering unclued solutions immediately
            return {
                allowed: true,
                solvedCount: 0,
                requiredCount: 0,
                totalCells: clue.cell_indices.length,
                reason: ''
            };
        }
        
        function applySolutionToGrid(clueId, solution) {
            console.log(`Applying solution "${solution}" to clue ${clueId}`);
            
            // Check if this is an anagram clue
            const isAnagramClue = clueId.startsWith('anagram_');
            
            // Save current state before applying solution
            saveState(clueId, solution);
            
            // Parse clue ID to get number and direction
            const [number, direction] = clueId.split('_');
            const clueNumber = parseInt(number);
            
            // Validate solution format
            if (!/^\d+$/.test(solution)) {
                showNotification('Solution must be a number', 'error');
                return;
            }
            
            // Get clue object (either regular or anagram)
            let clue;
            if (isAnagramClue) {
                clue = anagramClueObjects[clueId];
                if (!clue) {
                    showNotification('Anagram clue not found', 'error');
                    return;
                }
            } else {
                clue = clueObjects[clueId];
                if (!clue) {
                    showNotification('Clue not found', 'error');
                    return;
                }
            }
            
            // Validate solution length
            if (solution.length !== clue.length) {
                showNotification(`Solution must be ${clue.length} digits long`, 'error');
                return;
            }
            
            // For unclued clues, check constraints and conflicts (skip for anagram clues)
            if (clue.is_unclued && !isAnagramClue) {
                // Check constraint requirement first
                const constraintCheck = canEnterUncluedSolution(clueId);
                if (!constraintCheck.allowed) {
                    showNotification(constraintCheck.reason, 'error');
                    
                    // Show error in the unclued clue's error span
                    const errorSpan = document.getElementById(`error-${clueId}`);
                    if (errorSpan) {
                        errorSpan.textContent = constraintCheck.reason;
                        errorSpan.style.display = 'inline';
                    }
                    return;
                }
                
                const solutionStr = solution.padStart(clue.length, '0');
                const conflicts = [];
                
                // Check each cell position against already solved cells
                for (let i = 0; i < clue.cell_indices.length; i++) {
                    const cellIndex = clue.cell_indices[i];
                    const digit = parseInt(solutionStr[i]);
                    
                    // If this cell is already solved, check if it conflicts
                    if (cellIndex in solvedCells) {
                        if (solvedCells[cellIndex] !== digit) {
                            // Find which clue this cell belongs to for better error message
                            let conflictingClue = '';
                            for (const [otherClueId, otherClue] of Object.entries(clueObjects)) {
                                if (otherClue.cell_indices.includes(cellIndex)) {
                                    conflictingClue = otherClueId;
                                    break;
                                }
                            }
                            conflicts.push(`Cell ${cellIndex} (clue ${conflictingClue}) already has value ${solvedCells[cellIndex]}, but your solution has ${digit}`);
                        }
                    }
                }
                
                if (conflicts.length > 0) {
                    const errorMsg = `Solution conflicts with existing values:\n${conflicts.join('\n')}`;
                    showNotification(errorMsg, 'error');
                    
                    // Show error in the unclued clue's error span
                    const errorSpan = document.getElementById(`error-${clueId}`);
                    if (errorSpan) {
                        errorSpan.textContent = 'Conflicts with existing solutions';
                        errorSpan.style.display = 'inline';
                    }
                    return;
                }
                
                // Clear any previous error
                const errorSpan = document.getElementById(`error-${clueId}`);
                if (errorSpan) {
                    errorSpan.style.display = 'none';
                }
            } else if (isAnagramClue) {
                // For anagram clues, check if solution is valid for this clue
                if (!clue.possible_solutions.includes(parseInt(solution))) {
                    showNotification('This anagram solution is not valid for this clue', 'error');
                    return;
                }
            } else {
                // For regular clues, check if solution is valid for this clue
                if (!clue.possible_solutions.includes(parseInt(solution))) {
                    showNotification('This solution is not valid for this clue', 'error');
                    return;
                }
            }
            
            // Apply solution to grid cells
            const solutionStr = solution.padStart(clue.length, '0');
            for (let i = 0; i < clue.cell_indices.length; i++) {
                const cellIndex = clue.cell_indices[i];
                const digit = parseInt(solutionStr[i]);
                
                if (isAnagramClue) {
                    // Apply to anagram grid
                    anagramSolvedCells[cellIndex] = digit;
                    updateAnagramCellDisplay(cellIndex, digit);
                } else {
                    // Apply to initial grid
                    solvedCells[cellIndex] = digit;
                    updateCellDisplay(cellIndex, digit);
                }
            }
            
                        // Mark clue as solved
            clue.possible_solutions = [parseInt(solution)];
            
            // Mark this as a user-selected solution
            if (isAnagramClue) {
                anagramUserSelectedSolutions.add(clueId);
                // Update the anagram clue data structure to reflect the selection
                if (anagramClueObjects[clueId]) {
                    anagramClueObjects[clueId].possible_solutions = [parseInt(solution)];
                    anagramClueObjects[clueId].anagram_solutions = [parseInt(solution)];
                }
            } else {
            userSelectedSolutions.add(clueId);
            }
            
            // Propagate constraints to crossing clues
            let eliminatedSolutions = [];
            if (!isAnagramClue) {
                eliminatedSolutions = propagateConstraints(clueId, solution);
            } else {
                eliminatedSolutions = propagateAnagramConstraints(clueId, solution);
            }
            
            // Update all clue displays
            updateAllClueDisplays();
            
            // Update anagram clue displays if this was an anagram solution
            if (isAnagramClue) {
                updateAnagramClueDisplays();
            }
            
            // Update progress
            updateProgress();
            
            // Show success message
            if (isAnagramClue) {
                showNotification(`Anagram solution applied to anagram grid!`, 'success');
            } else {
                const eliminatedCount = eliminatedSolutions.length;
                if (eliminatedCount > 0) {
                    showNotification(`Solution applied! Eliminated ${eliminatedCount} incompatible solutions from crossing clues.`, 'success');
                } else {
                    showNotification('Solution applied successfully!', 'success');
                }
            }
            
            // Update unclued clue displays after applying solution
            updateUncluedClueDisplays();
            
            // Hide the dropdown/input for both initial and anagram clues
            const dropdownDiv = document.getElementById(`dropdown-${clueId}`);
            const inputDiv = document.getElementById(`input-${clueId}`);
            if (dropdownDiv) dropdownDiv.style.display = 'none';
            if (inputDiv) inputDiv.style.display = 'none';
            
            // Also hide any deselect dialogs
            const deselectDialog = document.getElementById(`deselect-${clueId}`);
            if (deselectDialog) deselectDialog.style.display = 'none';
        }

        function propagateConstraints(clueId, solution) {
            const eliminatedSolutions = [];
            const clue = clueObjects[clueId];
            const solutionStr = solution.padStart(clue.length, '0');
            
            // Find all clues that share cells with this clue
            const crossingClues = [];
            for (const [otherClueId, otherClue] of Object.entries(clueObjects)) {
                if (otherClueId !== clueId) {
                    // Check if any cells overlap
                    const overlap = clue.cell_indices.filter(cell => 
                        otherClue.cell_indices.includes(cell)
                    );
                    if (overlap.length > 0) {
                        crossingClues.push(otherClueId);
                    }
                }
            }
            
            // Eliminate incompatible solutions from crossing clues
            for (const crossingClueId of crossingClues) {
                const crossingClue = clueObjects[crossingClueId];
                const solutionsToRemove = [];
                
                for (const possibleSolution of crossingClue.possible_solutions) {
                    const possibleStr = possibleSolution.toString().padStart(crossingClue.length, '0');
                    let incompatible = false;
                    
                    // Check each cell position
                    for (let i = 0; i < crossingClue.cell_indices.length; i++) {
                        const cellIndex = crossingClue.cell_indices[i];
                        const digit = parseInt(possibleStr[i]);
                        
                        // If this cell is already solved, check compatibility
                        if (cellIndex in solvedCells) {
                            if (solvedCells[cellIndex] !== digit) {
                                incompatible = true;
                                break;
                            }
                        }
                    }
                    
                    if (incompatible) {
                        solutionsToRemove.push(possibleSolution);
                    }
                }
                
                // Remove incompatible solutions
                for (const solutionToRemove of solutionsToRemove) {
                    crossingClue.possible_solutions = crossingClue.possible_solutions.filter(s => s !== solutionToRemove);
                    eliminatedSolutions.push({clueId: crossingClueId, solution: solutionToRemove});
                }
            }
            
            return eliminatedSolutions;
        }

        function updateAllClueDisplays() {
            // Update each clue's display based on current state
            for (const [clueId, clue] of Object.entries(clueObjects)) {
                updateClueDisplay(clueId, clue);
            }
        }

        function updateClueDisplay(clueId, clue) {
            const clueElement = document.querySelector(`[data-clue="${clueId}"]`);
            if (!clueElement) return;
            
                    // Update solution count - show count until committed, then show actual solution
        const countElement = clueElement.querySelector('.solution-count');
        if (countElement) {
            if (!clue.is_unclued) {
                if (clue.possible_solutions.length === 1 && userSelectedSolutions.has(clueId)) {
                    // User has committed the solution - show the actual solution
                    countElement.textContent = `${clue.possible_solutions[0]}`;
                } else {
                    // Show count of solutions (singular when only one)
                    countElement.textContent = `${clue.possible_solutions.length} ${clue.possible_solutions.length === 1 ? 'solution' : 'solutions'}`;
                }
            }
            // For unclued clues, the count will be updated by updateUncluedClueDisplays()
        }
            
            // Update clue styling based on solution count and user selection
            clueElement.className = 'clue';
            
            if (clue.possible_solutions.length === 1) {
                if (userSelectedSolutions.has(clueId)) {
                    // User manually selected this solution
                    clueElement.classList.add('user-selected');
                } else {
                    // Algorithm determined only one solution remains
                    clueElement.classList.add('algorithm-solved');
                }
            } else if (clue.possible_solutions.length > 1) {
                if (userSelectedSolutions.has(clueId)) {
                    // User selected a solution but there are still other possibilities
                    clueElement.classList.add('user-selected');
                } else {
                    // Multiple solutions available, no user selection
                    clueElement.classList.add('multiple');
                }
            } else if (clue.is_unclued) {
                clueElement.classList.add('unclued');
            }
            
            // Update dropdown options if it exists
            const dropdownDiv = document.getElementById(`dropdown-${clueId}`);
            if (dropdownDiv) {
                const select = dropdownDiv.querySelector('.solution-select');
                if (select) {
                    // Keep the first option (placeholder) and update only the solution options
                    const placeholderOption = select.querySelector('option[value=""]');
                    select.innerHTML = '';
                    
                    // Restore the placeholder option
                    if (placeholderOption) {
                        select.appendChild(placeholderOption);
                    } else {
                        const newPlaceholder = document.createElement('option');
                        newPlaceholder.value = '';
                        newPlaceholder.textContent = '-- Select a solution --';
                        select.appendChild(newPlaceholder);
                    }
                    
                    // Add the solution options
                    for (const solution of clue.possible_solutions) {
                        const option = document.createElement('option');
                        option.value = solution;
                        option.textContent = solution.toString().padStart(clue.length, '0');
                        select.appendChild(option);
                    }
                    
                    console.log(`Updated dropdown for ${clueId} with ${clue.possible_solutions.length} solutions`);
                }
            }
        }

        function updateProgress() {
            const filledCells = Object.keys(solvedCells).length;
            const percentage = (filledCells / 64) * 100;
            
            // Count solved clues (both user-selected and algorithm-determined)
            let solvedClues = 0;
            for (const clue of Object.values(clueObjects)) {
                if (clue.possible_solutions.length === 1) {
                    solvedClues++;
                }
            }
            
            document.querySelector('.progress-fill').style.width = percentage + '%';
            document.querySelector('.progress-stats').innerHTML = 
                `<div>Cells filled: ${filledCells}/64 (${percentage.toFixed(1)}%)</div>
                 <div>Clues solved: ${solvedClues}/24</div>`;
            
            // Check for puzzle completion
            if (filledCells === 64 && solvedClues === 24 && !window.puzzleCompleted) {
                window.puzzleCompleted = true;
                showCompletionCelebration();
            }
            
            // Update unclued clue displays
            updateUncluedClueDisplays();
        }
        
        function showCompletionCelebration() {
            // Create celebration modal
            const modal = document.createElement('div');
            modal.id = 'completion-celebration';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.5s ease-in;
            `;
            
            // Add CSS animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideIn {
                    from { transform: translateY(-50px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
                @keyframes confetti {
                    0% { transform: translateY(-100vh) rotate(0deg); }
                    100% { transform: translateY(100vh) rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            // Calculate solving statistics
            const solvingTime = Math.round((Date.now() - window.solvingStartTime) / 1000);
            const solutionsApplied = solutionHistory.filter(s => s.solution !== 'DESELECT').length;
            const undoOperations = solutionHistory.filter(s => s.solution === 'DESELECT').length;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                    color: white;
                    padding: 40px;
                    border-radius: 12px;
                    text-align: center;
                    max-width: 600px;
                    margin: 20px;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                    animation: slideIn 0.6s ease-out;
                    position: relative;
                    overflow: hidden;
                    border: 1px solid #495057;
                ">
                    <div style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        height: 4px;
                        background: linear-gradient(90deg, #28a745, #17a2b8, #007bff);
                        z-index: 1;
                    "></div>
                    
                    <h1 style="font-size: 2.2em; margin: 0 0 20px 0; color: #e9ecef; font-weight: 300; letter-spacing: 1px;">
                        ðŸŽ‰ Puzzle Complete! ðŸŽ‰
                    </h1>
                    
                    <div style="
                        background: rgba(255,255,255,0.08);
                        padding: 20px;
                        border-radius: 8px;
                        margin: 20px 0;
                        border: 1px solid rgba(255,255,255,0.1);
                    ">
                        <h3 style="margin: 0 0 15px 0; color: #28a745; font-weight: 500; font-size: 1.3em;">Solving Statistics</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; color: #e9ecef;">
                            <div><strong style="color: #17a2b8;">Time taken:</strong> ${Math.floor(solvingTime/60)}m ${solvingTime%60}s</div>
                            <div><strong style="color: #17a2b8;">Solutions applied:</strong> ${solutionsApplied}</div>
                            <div><strong style="color: #17a2b8;">Undo operations:</strong> ${undoOperations}</div>
                            <div><strong style="color: #17a2b8;">Completion rate:</strong> 100%</div>
                        </div>
                    </div>
                    
                    <div style="
                        background: rgba(255,255,255,0.08);
                        padding: 20px;
                        border-radius: 8px;
                        margin: 20px 0;
                        border: 1px solid rgba(255,255,255,0.1);
                    ">
                        <h3 style="margin: 0 0 15px 0; color: #17a2b8; font-weight: 500; font-size: 1.3em;">Ready for the Next Challenge?</h3>
                        <p style="margin: 0 0 15px 0; line-height: 1.6; color: #e9ecef;">
                            Congratulations! You've successfully completed the first stage of the puzzle. 
                            But a new challenge lies ahead...
                        </p>
                        <div style="
                            background: rgba(23, 162, 184, 0.15);
                            padding: 15px;
                            border-radius: 8px;
                            border-left: 4px solid #17a2b8;
                            text-align: center;
                            font-style: normal;
                            color: #e9ecef;
                        ">
                            <strong style="color: #17a2b8;">The Anagram Challenge:</strong><br>
                            "Solvers must submit a grid in which every entry is an anagram of its counterpart in the initial grid 
                            (same digits in a different order). For each of the unclued six-digit entries, the anagram is a multiple 
                            of its original value. The 48 numbers used (24 initial + 24 anagrams) are all different, and none starts with zero."
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <button onclick="showAnagramGridInline()" style="
                            background: linear-gradient(135deg, #28a745, #20c997);
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 8px;
                            font-size: 1.1em;
                            font-weight: 500;
                            cursor: pointer;
                            margin-right: 15px;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(40, 167, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(40, 167, 69, 0.3)'">
                            ðŸ§© Show Anagram Grid
                        </button>
                        <button onclick="hideCompletionCelebration()" style="
                            background: rgba(255,255,255,0.1);
                            color: white;
                            border: 1px solid rgba(255,255,255,0.2);
                            padding: 15px 30px;
                            border-radius: 8px;
                            font-size: 1.1em;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                            Continue Solving
                        </button>
                    </div>
                </div>
            `;
            
            // Add gradient animation
            const gradientStyle = document.createElement('style');
            gradientStyle.textContent = `
                @keyframes gradientShift {
                    0% { background-position: 0% 50%; }
                    50% { background-position: 100% 50%; }
                    100% { background-position: 0% 50%; }
                }
            `;
            document.head.appendChild(gradientStyle);
            
            // Add subtle glow animation for celebrations
            const modalContent = modal.querySelector('div');
            modalContent.style.animation = 'slideIn 0.6s ease-out, subtleGlow 3s ease-in-out infinite';
            
            document.body.appendChild(modal);
        }
        
        function createConfetti() {
            // Removed confetti for sophisticated design
            // The subtle glow animation provides sufficient celebration effect
        }
        
        function hideCompletionCelebration() {
            const modal = document.getElementById('completion-celebration');
            if (modal) {
                modal.style.animation = 'fadeIn 0.5s ease-in reverse';
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.remove();
                    }
                }, 500);
            }
        }
        
        function showAnagramGridInline() {
            // Hide celebration modal
            hideCompletionCelebration();
            
            // Generate anagram clues dynamically
            generateAnagramClues();
            
            // Show anagram grid section (do not hide initial grid)
            const anagramGridSection = document.getElementById('anagram-grid-section');
            if (anagramGridSection) {
                anagramGridSection.style.display = 'block';
            }

            
            // Hide original clues and show anagram clues
            const initialCluesContainer = document.getElementById('initial-clues-container');
            const anagramCluesContainer = document.getElementById('anagram-clues-container');
            if (initialCluesContainer) {
                initialCluesContainer.style.display = 'none';
            }
            if (anagramCluesContainer) {
                anagramCluesContainer.style.display = 'block';
            }
            
            // Reset progress bar to zero for anagram grid
            document.querySelector('.progress-fill').style.width = '0%';
            document.querySelector('.progress-stats').innerHTML = 
                `<div>Cells filled: 0/64 (0.0%)</div>
                 <div>Clues solved: 0/24</div>`;
            
            // Show anagram fill button
            document.getElementById('dev-fill-anagram').style.display = 'inline-block';
            
            // Scroll to anagram grid section
            if (anagramGridSection) {
                anagramGridSection.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        function generateAnagramClues() {
            // Create anagram clue objects from solved clues
            const solvedClues = [];
            for (const [clueId, clue] of Object.entries(clueObjects)) {
                if (clue.possible_solutions.length === 1) {
                    // This clue is solved, create anagram data
                    const originalSolution = clue.possible_solutions[0];
                    const anagramSolutions = generateAnagramSolutionsForClue(originalSolution, clue.length, clue.is_unclued);
                    
                    anagramClueObjects[`anagram_${clueId}`] = {
                        'number': clue.number,
                        'direction': clue.direction,
                        'cell_indices': clue.cell_indices,
                        'length': clue.length,
                        'is_unclued': clue.is_unclued,
                        'possible_solutions': anagramSolutions,
                        'original_solution_count': anagramSolutions.length,
                        'original_solution': originalSolution,
                        'anagram_solutions': anagramSolutions
                    };
                    solvedClues.push({clueId, originalSolution, anagramSolutions});
                }
            }
            
            // Apply constraint elimination to anagram solutions
            applyAnagramConstraints();
            
            // Generate HTML for anagram clues using the updated anagramClueObjects
            generateAnagramCluesHTMLFromObjects();
        }
        
        function generateAnagramSolutionsForClue(originalSolution, length, isUnclued) {
            const originalStr = originalSolution.toString().padStart(length, '0');
            const anagrams = new Set(); // Use Set to eliminate duplicates
            
            if (length === 2) {
                // For 2-digit numbers, just swap the digits
                const swapped = originalStr[1] + originalStr[0];
                if (swapped !== originalStr) {
                    anagrams.add(parseInt(swapped));
                }
            } else {
                // Generate all permutations except the original
                const digits = originalStr.split('');
                const perms = generatePermutations(digits);
                
                for (const perm of perms) {
                    const anagramStr = perm.join('');
                    if (anagramStr !== originalStr && anagramStr[0] !== '0') {
                        const anagramNum = parseInt(anagramStr);
                        
                        if (isUnclued) {
                            // For unclued clues, anagrams must be multiples of the original
                            if (anagramNum % originalSolution === 0) {
                                anagrams.add(anagramNum);
                            }
                        } else {
                            // For clued clues, any anagram is valid
                            anagrams.add(anagramNum);
                        }
                    }
                }
            }
            
            return Array.from(anagrams).sort((a, b) => a - b);
        }
        
        function generatePermutations(arr) {
            if (arr.length <= 1) return [arr];
            
            const perms = [];
            for (let i = 0; i < arr.length; i++) {
                const current = arr[i];
                const remaining = arr.slice(0, i).concat(arr.slice(i + 1));
                const remainingPerms = generatePermutations(remaining);
                
                for (const perm of remainingPerms) {
                    perms.push([current, ...perm]);
                }
            }
            
            return perms;
        }
        
        function applyAnagramConstraints() {
            // Apply constraint elimination to anagram solutions with a more balanced approach
            for (const [anagramClueId, anagramClue] of Object.entries(anagramClueObjects)) {
                const originalClueId = anagramClueId.replace('anagram_', '');
                const originalClue = clueObjects[originalClueId];
                
                if (!originalClue) continue;
                
                // For the anagram stage, we want to provide more choice to the user
                // Only apply constraints if there are already solved cells in the anagram grid AND constraints are enabled
                const hasSolvedAnagramCells = Object.keys(anagramSolvedCells).length > 0;
                
                if (hasSolvedAnagramCells && anagramConstraintsEnabled) {
                    // Get available digits from crossing clues that are already solved
                    const availableDigits = getAvailableDigitsForAnagramClue(anagramClueId);
                    
                    // Filter anagram solutions based on available digits
                    const validAnagrams = [];
                    for (const anagram of anagramClue.anagram_solutions) {
                        if (isAnagramValidWithConstraints(anagram, anagramClue, availableDigits)) {
                            validAnagrams.push(anagram);
                        }
                    }
                    
                    // Update the anagram clue with filtered solutions
                    anagramClue.anagram_solutions = validAnagrams;
                    anagramClue.possible_solutions = validAnagrams;
                    
                    console.log(`Anagram clue ${anagramClueId}: ${anagramClue.original_solution_count} -> ${validAnagrams.length} valid anagrams (with constraints)`);
                } else {
                    // No solved cells yet - show all anagram solutions to give user choice
                    anagramClue.anagram_solutions = anagramClue.anagram_solutions || [];
                    anagramClue.possible_solutions = anagramClue.anagram_solutions;
                    
                    console.log(`Anagram clue ${anagramClueId}: ${anagramClue.anagram_solutions.length} anagrams available (no constraints yet)`);
                }
            }
        }
        
        function getAvailableDigitsForAnagramClue(anagramClueId) {
            const originalClueId = anagramClueId.replace('anagram_', '');
            const anagramClue = anagramClueObjects[anagramClueId];
            const originalClue = clueObjects[originalClueId];
            
            if (!anagramClue || !originalClue) return {};
            
            const availableDigits = {};
            
            // For each cell position in the anagram clue
            for (let i = 0; i < anagramClue.cell_indices.length; i++) {
                const cellIndex = anagramClue.cell_indices[i];
                const availableDigitsForCell = new Set();
                
                // Find all clues that use this cell
                for (const [otherClueId, otherClue] of Object.entries(clueObjects)) {
                    if (otherClueId !== originalClueId && otherClue.cell_indices.includes(cellIndex)) {
                        // This is a crossing clue - get its anagram solutions
                        const crossingAnagramClueId = `anagram_${otherClueId}`;
                        const crossingAnagramClue = anagramClueObjects[crossingAnagramClueId];
                        
                        if (crossingAnagramClue) {
                            // Get all possible digits at this position from crossing anagram solutions
                            for (const anagramSolution of crossingAnagramClue.anagram_solutions) {
                                const anagramStr = anagramSolution.toString().padStart(crossingAnagramClue.length, '0');
                                const digitAtPosition = anagramStr[otherClue.cell_indices.indexOf(cellIndex)];
                                availableDigitsForCell.add(parseInt(digitAtPosition));
                            }
                        }
                    }
                }
                
                // If no crossing clues found, all digits are available
                if (availableDigitsForCell.size === 0) {
                    for (let digit = 0; digit <= 9; digit++) {
                        availableDigitsForCell.add(digit);
                    }
                }
                
                availableDigits[i] = Array.from(availableDigitsForCell);
            }
            
            return availableDigits;
        }
        
        function isAnagramValidWithConstraints(anagram, anagramClue, availableDigits) {
            const anagramStr = anagram.toString().padStart(anagramClue.length, '0');
            
            // Check each digit position
            for (let i = 0; i < anagramClue.length; i++) {
                const digit = parseInt(anagramStr[i]);
                const availableForPosition = availableDigits[i];
                
                if (!availableForPosition.includes(digit)) {
                    return false;
                }
            }
            
            return true;
        }
        
        function propagateAnagramConstraints(clueId, solution) {
            const eliminatedSolutions = [];
            const anagramClue = anagramClueObjects[clueId];
            const originalClueId = clueId.replace('anagram_', '');
            const originalClue = clueObjects[originalClueId];
            
            if (!anagramClue || !originalClue) return eliminatedSolutions;
            
            const solutionStr = solution.toString().padStart(anagramClue.length, '0');
            
            // Find all anagram clues that share cells with this clue
            const crossingAnagramClues = [];
            for (const [otherAnagramClueId, otherAnagramClue] of Object.entries(anagramClueObjects)) {
                if (otherAnagramClueId !== clueId) {
                    // Check if any cells overlap
                    const overlap = anagramClue.cell_indices.filter(cell => 
                        otherAnagramClue.cell_indices.includes(cell)
                    );
                    if (overlap.length > 0) {
                        crossingAnagramClues.push(otherAnagramClueId);
                    }
                }
            }
            
            // Eliminate incompatible anagram solutions from crossing clues
            for (const crossingAnagramClueId of crossingAnagramClues) {
                const crossingAnagramClue = anagramClueObjects[crossingAnagramClueId];
                const solutionsToRemove = [];
                
                for (const possibleAnagram of crossingAnagramClue.anagram_solutions) {
                    const possibleStr = possibleAnagram.toString().padStart(crossingAnagramClue.length, '0');
                    let incompatible = false;
                    
                    // Check each cell position
                    for (let i = 0; i < crossingAnagramClue.cell_indices.length; i++) {
                        const cellIndex = crossingAnagramClue.cell_indices[i];
                        const digit = parseInt(possibleStr[i]);
                        
                        // If this cell is already solved in the anagram grid, check compatibility
                        if (cellIndex in anagramSolvedCells) {
                            if (anagramSolvedCells[cellIndex] !== digit) {
                                incompatible = true;
                                break;
                            }
                        }
                    }
                    
                    if (incompatible) {
                        solutionsToRemove.push(possibleAnagram);
                    }
                }
                
                // Remove incompatible solutions
                for (const solutionToRemove of solutionsToRemove) {
                    crossingAnagramClue.anagram_solutions = crossingAnagramClue.anagram_solutions.filter(s => s !== solutionToRemove);
                    crossingAnagramClue.possible_solutions = crossingAnagramClue.possible_solutions.filter(s => s !== solutionToRemove);
                    eliminatedSolutions.push({clueId: crossingAnagramClueId, solution: solutionToRemove});
                }
            }
            
            return eliminatedSolutions;
        }
        
        function generateAnagramCluesHTML(solvedClues) {
            // Separate clues by direction
            const acrossClues = solvedClues.filter(c => c.clueId.includes('_ACROSS'));
            const downClues = solvedClues.filter(c => c.clueId.includes('_DOWN'));
            
            // Generate across clues HTML
            const acrossContainer = document.getElementById('anagram-across-clues');
            if (acrossContainer) {
                acrossContainer.innerHTML = '';
                for (const clue of acrossClues) {
                    const clueId = `anagram_${clue.clueId}`;
                    const clueNumber = clue.clueId.split('_')[0];
                    
                    // Determine CSS class based on anagram count
                    let statusClass = '';
                    if (clue.anagramSolutions.length > 1) {
                        statusClass = 'multiple'; // Multiple anagrams available
                    } else if (clue.anagramSolutions.length === 1) {
                        statusClass = ''; // Default state
                    } else {
                        statusClass = 'unclued'; // No anagrams available
                    }
                    
                    const clueHTML = `
                        <div class="clue anagram-clue ${statusClass}" data-clue="${clueId}" data-grid-type="anagram">
                            <div class="clue-header">
                                <span class="clue-number">${clueNumber}.</span>
                                <span class="clue-text">${clue.originalSolution}</span>
                                <span class="solution-count">${clue.anagramSolutions.length} ${clue.anagramSolutions.length === 1 ? 'anagram' : 'anagrams'}</span>
                            </div>
                            ${clue.anagramSolutions.length > 0 ? `
                                <div class="solution-dropdown" id="dropdown-${clueId}" style="display: none;">
                                    <select class="solution-select" data-clue="${clueId}">
                                        <option value="">-- Select an anagram --</option>
                                        ${clue.anagramSolutions.map(anagram => `<option value="${anagram}">${anagram}</option>`).join('')}
                                    </select>
                                    <button class="apply-solution" data-clue="${clueId}">Apply</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    acrossContainer.innerHTML += clueHTML;
                }
            }
            
            // Generate down clues HTML
            const downContainer = document.getElementById('anagram-down-clues');
            if (downContainer) {
                downContainer.innerHTML = '';
                for (const clue of downClues) {
                    const clueId = `anagram_${clue.clueId}`;
                    const clueNumber = clue.clueId.split('_')[0];
                    
                    // Determine CSS class based on anagram count
                    let statusClass = '';
                    if (clue.anagramSolutions.length > 1) {
                        statusClass = 'multiple'; // Multiple anagrams available
                    } else if (clue.anagramSolutions.length === 1) {
                        statusClass = ''; // Default state
                    } else {
                        statusClass = 'unclued'; // No anagrams available
                    }
                    
                    const clueHTML = `
                        <div class="clue anagram-clue ${statusClass}" data-clue="${clueId}" data-grid-type="anagram">
                            <div class="clue-header">
                                <span class="clue-number">${clueNumber}.</span>
                                <span class="clue-text">${clue.originalSolution}</span>
                                <span class="solution-count">${clue.anagramSolutions.length} ${clue.anagramSolutions.length === 1 ? 'anagram' : 'anagrams'}</span>
                            </div>
                            ${clue.anagramSolutions.length > 0 ? `
                                <div class="solution-dropdown" id="dropdown-${clueId}" style="display: none;">
                                    <select class="solution-select" data-clue="${clueId}">
                                        <option value="">-- Select an anagram --</option>
                                        ${clue.anagramSolutions.map(anagram => `<option value="${anagram}">${anagram}</option>`).join('')}
                                    </select>
                                    <button class="apply-solution" data-clue="${clueId}">Apply</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    downContainer.innerHTML += clueHTML;
                }
            }
        }
        
        function generateAnagramCluesHTMLFromObjects() {
            // Generate HTML using the updated anagramClueObjects (after constraint elimination)
            const acrossClues = [];
            const downClues = [];
            
            for (const [clueId, clue] of Object.entries(anagramClueObjects)) {
                if (clue.direction === 'ACROSS') {
                    acrossClues.push({clueId, clue});
                } else {
                    downClues.push({clueId, clue});
                }
            }
            
            // Sort by clue number
            acrossClues.sort((a, b) => a.clue.number - b.clue.number);
            downClues.sort((a, b) => a.clue.number - b.clue.number);
            
            // Generate across clues HTML
            const acrossContainer = document.getElementById('anagram-across-clues');
            if (acrossContainer) {
                acrossContainer.innerHTML = '';
                for (const {clueId, clue} of acrossClues) {
                    const clueNumber = clue.number;
                    
                    // Determine CSS class based on filtered anagram count
                    let statusClass = '';
                    if (clue.anagram_solutions.length > 1) {
                        statusClass = 'multiple'; // Multiple anagrams available
                    } else if (clue.anagram_solutions.length === 1) {
                        statusClass = ''; // Default state
                    } else {
                        statusClass = 'unclued'; // No anagrams available
                    }
                    
                    const clueHTML = `
                        <div class="clue anagram-clue ${statusClass}" data-clue="${clueId}" data-grid-type="anagram">
                            <div class="clue-header">
                                <span class="clue-number">${clueNumber}.</span>
                                <span class="clue-text">${clue.original_solution}</span>
                                <span class="solution-count">${clue.anagram_solutions.length} ${clue.anagram_solutions.length === 1 ? 'anagram' : 'anagrams'}</span>
                            </div>
                            ${clue.anagram_solutions.length > 0 ? `
                                <div class="solution-dropdown" id="dropdown-${clueId}" style="display: none;">
                                    <select class="solution-select" data-clue="${clueId}">
                                        <option value="">-- Select an anagram --</option>
                                        ${clue.anagram_solutions.map(anagram => `<option value="${anagram}">${anagram}</option>`).join('')}
                                    </select>
                                    <button class="apply-solution" data-clue="${clueId}">Apply</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    acrossContainer.innerHTML += clueHTML;
                }
            }
            
            // Generate down clues HTML
            const downContainer = document.getElementById('anagram-down-clues');
            if (downContainer) {
                downContainer.innerHTML = '';
                for (const {clueId, clue} of downClues) {
                    const clueNumber = clue.number;
                    
                    // Determine CSS class based on filtered anagram count
                    let statusClass = '';
                    if (clue.anagram_solutions.length > 1) {
                        statusClass = 'multiple'; // Multiple anagrams available
                    } else if (clue.anagram_solutions.length === 1) {
                        statusClass = ''; // Default state
                    } else {
                        statusClass = 'unclued'; // No anagrams available
                    }
                    
                    const clueHTML = `
                        <div class="clue anagram-clue ${statusClass}" data-clue="${clueId}" data-grid-type="anagram">
                            <div class="clue-header">
                                <span class="clue-number">${clueNumber}.</span>
                                <span class="clue-text">${clue.original_solution}</span>
                                <span class="solution-count">${clue.anagram_solutions.length} ${clue.anagram_solutions.length === 1 ? 'anagram' : 'anagrams'}</span>
                            </div>
                            ${clue.anagram_solutions.length > 0 ? `
                                <div class="solution-dropdown" id="dropdown-${clueId}" style="display: none;">
                                    <select class="solution-select" data-clue="${clueId}">
                                        <option value="">-- Select an anagram --</option>
                                        ${clue.anagram_solutions.map(anagram => `<option value="${anagram}">${anagram}</option>`).join('')}
                                    </select>
                                    <button class="apply-solution" data-clue="${clueId}">Apply</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    downContainer.innerHTML += clueHTML;
                }
            }
        }
        
        function hideAnagramGrid() {
            // Hide anagram clues, show initial clues
            const initialCluesContainer = document.getElementById('initial-clues-container');
            const anagramCluesContainer = document.getElementById('anagram-clues-container');
            if (initialCluesContainer) {
                initialCluesContainer.style.display = 'block';
            }
            if (anagramCluesContainer) {
                anagramCluesContainer.style.display = 'none';
            }
            // Do NOT hide either grid
            // const anagramGridSection = document.getElementById('anagram-grid-section');
            // if (anagramGridSection) {
            //     anagramGridSection.style.display = 'none';
            // }
            // const initialGridSection = document.getElementById('initial-grid-section');
            // if (initialGridSection) {
            //     initialGridSection.style.display = 'block';
            // }
        }
        
        function toggleAnagramMode() {
            const initialCluesContainer = document.getElementById('initial-clues-container');
            const anagramCluesContainer = document.getElementById('anagram-clues-container');
            const toggleButton = document.getElementById('dev-toggle-anagram');
            
            if (initialCluesContainer && anagramCluesContainer) {
                const isAnagramMode = anagramCluesContainer.style.display === 'block';
                
                if (isAnagramMode) {
                    // Switch to initial mode
                    initialCluesContainer.style.display = 'block';
                    anagramCluesContainer.style.display = 'none';
                    toggleButton.textContent = 'Toggle Anagram Mode';
                    toggleButton.style.backgroundColor = '#17a2b8';
                    // Hide anagram fill button
                    document.getElementById('dev-fill-anagram').style.display = 'none';
                    showNotification('Switched to Initial Grid Mode', 'info');
                    // Update progress for initial grid
                    updateProgress();
                } else {
                    // Switch to anagram mode
                    initialCluesContainer.style.display = 'none';
                    anagramCluesContainer.style.display = 'block';
                    toggleButton.textContent = 'Toggle Initial Mode';
                    toggleButton.style.backgroundColor = '#28a745';
                    // Show anagram fill button
                    document.getElementById('dev-fill-anagram').style.display = 'inline-block';
                    showNotification('Switched to Anagram Grid Mode', 'info');
                    // Reset progress bar to zero for anagram grid
                    document.querySelector('.progress-fill').style.width = '0%';
                    document.querySelector('.progress-stats').innerHTML = 
                        `<div>Cells filled: 0/64 (0.0%)</div>
                         <div>Clues solved: 0/24</div>`;
                }
            }
        }
        
        function toggleConstraints() {
            anagramConstraintsEnabled = !anagramConstraintsEnabled;
            const toggleButton = document.getElementById('dev-toggle-constraints');
            
            if (anagramConstraintsEnabled) {
                toggleButton.textContent = 'Constraints: ON';
                toggleButton.style.backgroundColor = '#6f42c1';
                showNotification('Anagram constraints enabled - solutions will be filtered based on crossing clues', 'info');
            } else {
                toggleButton.textContent = 'Constraints: OFF';
                toggleButton.style.backgroundColor = '#dc3545';
                showNotification('Anagram constraints disabled - all anagram solutions will be shown', 'info');
            }
            
            // Regenerate anagram clues with new constraint setting
            if (Object.keys(anagramClueObjects).length > 0) {
                applyAnagramConstraints();
                generateAnagramCluesHTMLFromObjects();
            }
        }
        
        function getFilteredCandidatesForClue(clueId) {
            const clue = clueObjects[clueId];
            if (!clue || !clue.is_unclued) {
                return [];
            }
            
            // Use the embedded unclued candidates list (305 numbers that satisfy anagram/multiple constraint)
            const uncluedCandidates = [100035, 100089, 100350, 100449, 100890, 100899, 100989, 102249, 102375, 102564, 103428, 103500, 103845, 104490, 104499, 104769, 104895, 105264, 106254, 106749, 106848, 107235, 107583, 107793, 107892, 108726, 108900, 108990, 108999, 109890, 109899, 109989, 111873, 113724, 113967, 114237, 114528, 116397, 116688, 116880, 116988, 118731, 118830, 118833, 119883, 120267, 123507, 123714, 123750, 123876, 123975, 124137, 124875, 125406, 125604, 125874, 126054, 126702, 126873, 126888, 127389, 128034, 128052, 128205, 128574, 129003, 129030, 129033, 129903, 130029, 130149, 130290, 130299, 130329, 130869, 132159, 132903, 133029, 133359, 133449, 133590, 133599, 133659, 134490, 134499, 134505, 134739, 135045, 135900, 135990, 135999, 136590, 136599, 136659, 137124, 137241, 137286, 138402, 138456, 138546, 138600, 138627, 139860, 139986, 140085, 140184, 140247, 140256, 140526, 140850, 140985, 141237, 141858, 142371, 142470, 142497, 142587, 142857, 143505, 143793, 143856, 145035, 145281, 145386, 147024, 147240, 148257, 148509, 148590, 148599, 149085, 149724, 149859, 150192, 150345, 150435, 151893, 151920, 151992, 153846, 154269, 154386, 154896, 156282, 156942, 157284, 158427, 158598, 159786, 166782, 167604, 167802, 167820, 167832, 167982, 168027, 169728, 169782, 170268, 172575, 172968, 174285, 174825, 175257, 175725, 176004, 176034, 176040, 176049, 176604, 178002, 178020, 178200, 178302, 178320, 178332, 178437, 179487, 179802, 179820, 179832, 179982, 180027, 180267, 180270, 180327, 182703, 182973, 183027, 188547, 189657, 190476, 194787, 196587, 196728, 197280, 197283, 197298, 197328, 197604, 197802, 197820, 197832, 197982, 198027, 199728, 199782, 200178, 201678, 201780, 201783, 201798, 201978, 205128, 206793, 206856, 207693, 212805, 215628, 216678, 216780, 216783, 216798, 216978, 217800, 217830, 217833, 217980, 217983, 217998, 219780, 219783, 219798, 219978, 230679, 230769, 230895, 233958, 235071, 235107, 237114, 237141, 237501, 237510, 238095, 238761, 239508, 239580, 239583, 239598, 239658, 239751, 239958, 240147, 241137, 241371, 241470, 241497, 242748, 247014, 247140, 247428, 247500, 248274, 248760, 248976, 249714, 249750, 249876, 249975, 251757, 257175, 257517, 258714, 258741, 271584, 274248, 274824, 275850, 275886, 275985, 276489, 280341, 281034, 282474, 284157, 285714, 285741, 285750, 285876, 285975, 287586, 287649, 288576, 297585, 298575, 306792, 307692, 314379, 320679, 320769, 412587, 412857, 425871, 428571];
            const filteredCandidates = [];
            
            for (const candidate of uncluedCandidates) {
                if (candidate.toString().length === clue.length) {
                    // Check if this candidate conflicts with already solved cells
                    let conflicts = false;
                    const candidateStr = candidate.toString().padStart(clue.length, '0');
                    
                    for (let i = 0; i < clue.cell_indices.length; i++) {
                        const cellIndex = clue.cell_indices[i];
                        if (cellIndex in solvedCells) {
                            if (solvedCells[cellIndex] !== parseInt(candidateStr[i])) {
                                conflicts = true;
                                break;
                            }
                        }
                    }
                    
                    if (!conflicts) {
                        filteredCandidates.push(candidate);
                    }
                }
            }
            
            return filteredCandidates;
        }
        

        
        function updateUncluedClueDisplays() {
            // Update each unclued clue to show candidate count
            for (const [clueId, clue] of Object.entries(clueObjects)) {
                if (clue.is_unclued) {
                    const clueElement = document.querySelector(`[data-clue="${clueId}"]`);
                    const inputDiv = document.getElementById(`input-${clueId}`);
                    const dropdownDiv = document.getElementById(`dropdown-${clueId}`);
                    const countElement = document.getElementById(`unclued-count-${clueId}`);
                    
                    if (clueElement) {
                        const candidates = getFilteredCandidatesForClue(clueId);
                        const candidateCount = candidates.length;
                        
                        // Update the count element (right-aligned, no parentheses, no italics)
                        if (countElement) {
                            if (userSelectedSolutions.has(clueId)) {
                                countElement.textContent = `Solved: ${clue.possible_solutions[0]}`;
                            } else {
                                countElement.textContent = `${candidateCount} ${candidateCount === 1 ? 'candidate' : 'candidates'}`;
                            }
                        }
                        
                        // Check if this clue has a user-selected solution
                        if (userSelectedSolutions.has(clueId)) {
                            // Clue is solved - hide both input and dropdown
                            if (dropdownDiv) dropdownDiv.style.display = 'none';
                            if (inputDiv) inputDiv.style.display = 'none';
                        } else {
                            // Hide both input and dropdown - they'll show when clicked
                            if (dropdownDiv) dropdownDiv.style.display = 'none';
                            if (inputDiv) inputDiv.style.display = 'none';
                        }
                    }
                }
            }
        }

        function showNotification(message, type) {
            // Remove existing notifications
            const existing = document.querySelector('.notification');
            if (existing) {
                existing.remove();
            }
            
            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // Append to main-content instead of body
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.appendChild(notification);
            } else {
                document.body.appendChild(notification);
            }
            
            // Show notification
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 10);
            
            // Hide notification after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        function showDeselectDialog(clueId) {
            // Hide any existing dialogs
            document.querySelectorAll('.solution-dropdown, .solution-input, .deselect-dialog').forEach(d => {
                d.style.display = 'none';
            });
            
            const clue = clueObjects[clueId];
            const currentSolution = clue.possible_solutions[0];
            const solutionStr = currentSolution.toString().padStart(clue.length, '0');
            
            // Create deselect dialog
            const dialog = document.createElement('div');
            dialog.className = 'deselect-dialog';
            dialog.id = `deselect-${clueId}`;
            dialog.style.cssText = `
                margin-top: 8px;
                padding: 12px;
                background-color: #fff3cd;
                border: 1px solid #ffeaa7;
                border-radius: 4px;
                border-left: 4px solid #f39c12;
            `;
            
            dialog.innerHTML = `
                <div style="margin-bottom: 8px; font-weight: bold; color: #856404;">
                    Current solution: <span style="font-family: monospace;">${solutionStr}</span>
                </div>
                <div style="margin-bottom: 12px; color: #856404;">
                    Click "Deselect" to remove this solution and restore all possible solutions for this clue.
                </div>
                <button class="deselect-solution" data-clue="${clueId}" style="
                    background-color: #dc3545;
                    color: white;
                    border: none;
                    padding: 6px 12px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                    margin-right: 8px;
                ">Deselect Solution</button>
                <button class="cancel-deselect" style="
                    background-color: #6c757d;
                    color: white;
                    border: none;
                    padding: 6px 12px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                ">Cancel</button>
            `;
            
            // Find the clue element and append the dialog
            const clueElement = document.querySelector(`[data-clue="${clueId}"]`);
            if (clueElement) {
                clueElement.appendChild(dialog);
                
                // Add event listeners
                dialog.querySelector('.deselect-solution').addEventListener('click', function(e) {
                    e.stopPropagation();
                    deselectSolution(clueId);
                });
                
                dialog.querySelector('.cancel-deselect').addEventListener('click', function(e) {
                    e.stopPropagation();
                    dialog.style.display = 'none';
                });
            }
        }

        function deselectSolution(clueId) {
            console.log(`Deselecting solution for clue ${clueId}`);
            
            // Save current state before deselecting
            saveState(clueId, 'DESELECT');
            
            // Check if this is an anagram clue
            const isAnagramClue = clueId.startsWith('anagram_');
            
            if (isAnagramClue) {
                // Handle anagram clue deselection
                const anagramClue = anagramClueObjects[clueId];
                if (!anagramClue) {
                    showNotification('Anagram clue not found', 'error');
                    return;
                }
                
                const currentSolution = anagramClue.possible_solutions[0];
                const solutionStr = currentSolution.toString().padStart(anagramClue.length, '0');
                
                // Remove the solution from the anagram grid cells
                for (let i = 0; i < anagramClue.cell_indices.length; i++) {
                    const cellIndex = anagramClue.cell_indices[i];
                    
                    // Check if this cell is used by other user-selected anagram clues
                    let canRemoveCell = true;
                    for (const [otherClueId, otherClue] of Object.entries(anagramClueObjects)) {
                        if (otherClueId !== clueId && anagramUserSelectedSolutions.has(otherClueId)) {
                            if (otherClue.cell_indices.includes(cellIndex)) {
                                canRemoveCell = false;
                                break;
                            }
                        }
                    }
                    
                    if (canRemoveCell) {
                        delete anagramSolvedCells[cellIndex];
                        
                        // Clear the anagram cell display
                        const cell = document.querySelector(`[data-cell="${cellIndex}"][data-anagram="true"]`);
                        if (cell) {
                            const valueElement = cell.querySelector('.cell-value');
                            if (valueElement) {
                                valueElement.remove();
                            }
                        }
                    }
                }
                
                // Remove from anagram user-selected solutions
                anagramUserSelectedSolutions.delete(clueId);
                
                // Restore original anagram solutions for the deselected clue
                const originalAnagramSolutions = anagramClue.anagram_solutions || [];
                anagramClue.possible_solutions = [...originalAnagramSolutions];
                
                // Update anagram clue displays
                updateAnagramClueDisplays();
                
                // Show success message
                const restoredCount = anagramClue.possible_solutions.length;
                showNotification(`Deselected anagram solution for clue ${clueId}. Restored ${restoredCount} possible anagrams.`, 'success');
                
            } else {
                // Handle initial clue deselection (existing logic)
                const clue = clueObjects[clueId];
                const currentSolution = clue.possible_solutions[0];
                
                // Remove the solution from the grid cells
                const solutionStr = currentSolution.toString().padStart(clue.length, '0');
                for (let i = 0; i < clue.cell_indices.length; i++) {
                    const cellIndex = clue.cell_indices[i];
                    
                    // Check if this cell is used by other user-selected clues
                    let canRemoveCell = true;
                    for (const [otherClueId, otherClue] of Object.entries(clueObjects)) {
                        if (otherClueId !== clueId && userSelectedSolutions.has(otherClueId)) {
                            if (otherClue.cell_indices.includes(cellIndex)) {
                                canRemoveCell = false;
                                break;
                            }
                        }
                    }
                    
                    if (canRemoveCell) {
                        delete solvedCells[cellIndex];
                        
                        // Clear the cell display
                        const cell = document.querySelector(`[data-cell="${cellIndex}"]`);
                        if (cell) {
                            const valueElement = cell.querySelector('.cell-value');
                            if (valueElement) {
                                valueElement.remove();
                            }
                        }
                    }
                }
                
                // Remove from user-selected solutions BEFORE recalculating constraints
                userSelectedSolutions.delete(clueId);
                
                // Explicitly restore original solutions for the deselected clue
                const originalCount = clue.original_solution_count || 0;
                console.log(`Restoring original solutions for ${clueId}: original count = ${originalCount}`);
                
                // Restore from stored original solutions
                if (originalSolutions[clueId]) {
                    clue.possible_solutions = [...originalSolutions[clueId]]; // Deep copy
                    console.log(`Restored original solutions for ${clueId}:`, originalSolutions[clueId]);
                } else {
                    console.log(`No original solutions found for ${clueId}`);
                    clue.possible_solutions = [];
                }
                
                // Recalculate constraints for all OTHER clues (not the deselected one)
                recalculateAllConstraintsExcept(clueId);
                
                // Update all clue displays
                updateAllClueDisplays();
                
                // Show success message
                const restoredCount = clue.possible_solutions.length;
                showNotification(`Deselected solution for clue ${clueId}. Restored ${restoredCount} possible solutions.`, 'success');
            }
            
            // Update progress
            updateProgress();
            
            // Hide the deselect dialog
            const dialog = document.getElementById(`deselect-${clueId}`);
            if (dialog) {
                dialog.style.display = 'none';
            }
        }

        function recalculateAllConstraintsExcept(excludeClueId) {
            // Recalculate constraints based on current solved cells, excluding the specified clue
            for (const [clueId, clue] of Object.entries(clueObjects)) {
                // Skip the excluded clue and clues that have user-selected solutions
                if (clueId === excludeClueId || userSelectedSolutions.has(clueId)) continue;
                
                // Get original solutions for this clue from our stored original solutions
                const clueOriginalSolutions = originalSolutions[clueId] || [];
                const validSolutions = [];
                
                // Check each original solution against current grid state
                for (const solution of clueOriginalSolutions) {
                    const solutionInt = parseInt(solution);
                    const solutionStr = solutionInt.toString().padStart(clue.length, '0');
                    let isValid = true;
                    
                    // Check each cell position
                    for (let i = 0; i < clue.cell_indices.length; i++) {
                        const cellIndex = clue.cell_indices[i];
                        const digit = parseInt(solutionStr[i]);
                        
                        // If this cell is already solved, check compatibility
                        if (cellIndex in solvedCells) {
                            if (solvedCells[cellIndex] !== digit) {
                                isValid = false;
                                break;
                            }
                        }
                    }
                    
                    if (isValid) {
                        validSolutions.push(solutionInt);
                    }
                }
                
                // Update the clue's possible solutions
                clue.possible_solutions = validSolutions;
            }
        }

        function recalculateAllConstraints() {
            // Recalculate constraints for all clues (used for undo operations)
            for (const [clueId, clue] of Object.entries(clueObjects)) {
                // Skip clues that have user-selected solutions
                if (userSelectedSolutions.has(clueId)) continue;
                
                // Get original solutions for this clue from our stored original solutions
                const clueOriginalSolutions = originalSolutions[clueId] || [];
                const validSolutions = [];
                
                // Check each original solution against current grid state
                for (const solution of clueOriginalSolutions) {
                    const solutionInt = parseInt(solution);
                    const solutionStr = solutionInt.toString().padStart(clue.length, '0');
                    let isValid = true;
                    
                    // Check each cell position
                    for (let i = 0; i < clue.cell_indices.length; i++) {
                        const cellIndex = clue.cell_indices[i];
                        const digit = parseInt(solutionStr[i]);
                        
                        // If this cell is already solved, check compatibility
                        if (cellIndex in solvedCells) {
                            if (solvedCells[cellIndex] !== digit) {
                                isValid = false;
                                break;
                            }
                        }
                    }
                    
                    if (isValid) {
                        validSolutions.push(solutionInt);
                    }
                }
                
                // Update the clue's possible solutions
                clue.possible_solutions = validSolutions;
            }
        }
        
        // Developer functions for quick testing
        function fill14A() {
            // Fill in clue 14A (unclued) with the known solution
            const solution = '142857';
            applySolutionToGrid('14_ACROSS', solution);
            showNotification('Filled 14A with solution 142857', 'success');
        }
        
        function fillCompleteGrid() {
            // Fill the complete grid with actual known solutions for testing
            const knownSolutions = {
                '1_ACROSS': '3375', // Known solution
                '1_DOWN': '3249', // Known solution
                '2_DOWN': '35', // Known solution
                '3_DOWN': '7776',    // From test file - 10:1 constraint
                '4_ACROSS': '5254',  // From solution_sets.json
                '5_DOWN': '2048',    // From solution_sets.json - 11:0 constraint
                '6_DOWN': '4207',    // From solution_sets.json
                '7_DOWN': '137241',  // From test file - actual unclued solution
                '8_DOWN': '119883', // Known solution
                '9_ACROSS': '72', // Known solution
                '10_ACROSS': '4173', // Known solution
                '11_ACROSS': '1430', // Known solution
                '12_ACROSS': '167982', // Known solution
                '13_DOWN': '5132', // Known solution
                '14_ACROSS': '142857', // Known solution
                '15_DOWN': '4225', // Known solution
                '16_DOWN': '5642', // Known solution
                '17_DOWN': '2401',   // From solution_sets.json
                '18_ACROSS': '1024', // From solution_sets.json
                '19_ACROSS': '8624', // Known solution
                '20_ACROSS': '32',   // From solution_sets.json
                '21_DOWN': '16', // Known solution
                '22_ACROSS': '2858', // Known solution
                '23_ACROSS': '9261', // Known solution
            };
            
            // Apply each solution
            for (const [clueId, solution] of Object.entries(knownSolutions)) {
                const clue = clueObjects[clueId];
                if (clue && solution.length === clue.length) {
                    console.log(`Applying solution ${solution} to clue ${clueId}`);
                    applySolutionToGrid(clueId, solution);
                } else {
                    console.log(`Skipping clue ${clueId} - not found or length mismatch`);
                }
            }
            
            showNotification('Filled grid with actual known solutions only', 'success');
        }
        
        function fillAnagramGrid() {
            // Fill the anagram grid with known anagram solutions for testing
            const knownAnagramSolutions = {
                'anagram_1_ACROSS': '3573', // Anagram of 3375
                'anagram_1_DOWN': '3942', // Anagram of 3249
                'anagram_2_DOWN': '53', // Anagram of 35
                'anagram_3_DOWN': '7677', // Anagram of 7776
                'anagram_4_ACROSS': '5452', // Anagram of 5254
                'anagram_5_DOWN': '4802', // Anagram of 2048
                'anagram_6_DOWN': '2740', // Anagram of 4207
                'anagram_7_DOWN': '411723', // Anagram of 137241 (multiple of original)
                'anagram_8_DOWN': '839181', // Anagram of 119883
                'anagram_9_ACROSS': '27', // Anagram of 72
                'anagram_10_ACROSS': '4371', // Anagram of 4173
                'anagram_11_ACROSS': '3014', // Anagram of 1430
                'anagram_12_ACROSS': '671928', // Anagram of 167982
                'anagram_13_DOWN': '3125', // Anagram of 5132
                'anagram_14_ACROSS': '857142', // Anagram of 142857 (multiple of original)
                'anagram_15_DOWN': '5422', // Anagram of 4225
                'anagram_16_DOWN': '4256', // Anagram of 5642
                'anagram_17_DOWN': '1402', // Anagram of 2401 (same)
                'anagram_18_ACROSS': '1042', // Anagram of 1024 (same)
                'anagram_19_ACROSS': '8264', // Anagram of 8624
                'anagram_20_ACROSS': '23', // Anagram of 32
                'anagram_21_DOWN': '61', // Anagram of 16
                'anagram_22_ACROSS': '5828', // Anagram of 2858 (same)
                'anagram_23_ACROSS': '9612', // Anagram of 9261
            };
            
            // First, make sure we have anagram clues generated
            if (Object.keys(anagramClueObjects).length === 0) {
                generateAnagramClues();
            }
            
            // Apply each anagram solution
            for (const [clueId, solution] of Object.entries(knownAnagramSolutions)) {
                const anagramClue = anagramClueObjects[clueId];
                if (anagramClue && solution.length === anagramClue.length) {
                    console.log(`Applying anagram solution ${solution} to clue ${clueId}`);
                    applySolutionToGrid(clueId, solution);
                } else {
                    console.log(`Skipping anagram clue ${clueId} - not found or length mismatch`);
                }
            }
            
            showNotification('Filled anagram grid with known anagram solutions', 'success');
        }

        // Add this function after updateAllClueDisplays
        function updateAnagramClueDisplays() {
            // Update each anagram clue's display based on current state
            for (const [clueId, clue] of Object.entries(anagramClueObjects)) {
                const clueElement = document.querySelector(`[data-clue="${clueId}"]`);
                if (!clueElement) continue;
                
                // Update the clue text to show selected solution or original
                const textElement = clueElement.querySelector('.clue-text');
                if (textElement) {
                    if (anagramUserSelectedSolutions.has(clueId)) {
                        // Show the selected anagram solution
                        const selectedSolution = clue.possible_solutions[0];
                        textElement.textContent = selectedSolution;
                    } else {
                        // Show the original solution
                        textElement.textContent = clue.original_solution;
                    }
                }
                
                        // Update the count text
        const countElement = clueElement.querySelector('.solution-count');
        if (countElement) {
            if (anagramUserSelectedSolutions.has(clueId)) {
                countElement.textContent = 'Selected';
            } else {
                // Show count of anagrams (singular when only one)
                const anagramText = clue.anagram_solutions.length === 1 ? 'anagram' : 'anagrams';
                countElement.textContent = `${clue.anagram_solutions.length} ${anagramText}`;
            }
        }
                
                // Remove all status classes and apply correct one
                clueElement.className = 'clue anagram-clue';
                if (anagramUserSelectedSolutions.has(clueId)) {
                    clueElement.classList.add('user-selected');
                } else if (clue.anagram_solutions && clue.anagram_solutions.length > 1) {
                    clueElement.classList.add('multiple');
                } else if (clue.anagram_solutions && clue.anagram_solutions.length === 0) {
                    clueElement.classList.add('unclued');
                }
                
                // Update dropdown options if it exists
                const dropdownDiv = document.getElementById(`dropdown-${clueId}`);
                if (dropdownDiv) {
                    const select = dropdownDiv.querySelector('.solution-select');
                    if (select) {
                        // Keep the first option (placeholder) and update only the solution options
                        const placeholderOption = select.querySelector('option[value=""]');
                        select.innerHTML = '';
                        
                        // Restore the placeholder option
                        if (placeholderOption) {
                            select.appendChild(placeholderOption);
                        } else {
                            const newPlaceholder = document.createElement('option');
                            newPlaceholder.value = '';
                            newPlaceholder.textContent = '-- Select an anagram --';
                            select.appendChild(newPlaceholder);
                        }
                        
                        // Add the anagram solution options
                        for (const solution of clue.anagram_solutions) {
                            const option = document.createElement('option');
                            option.value = solution;
                            option.textContent = solution.toString().padStart(clue.length, '0');
                            select.appendChild(option);
                        }
                        
                        console.log(`Updated anagram dropdown for ${clueId} with ${clue.anagram_solutions.length} solutions`);
                    }
                }
            }
        }

        // Modal system
        function createModal(id, title, content, buttons) {
            const existingModal = document.getElementById(id);
            if (existingModal) {
                existingModal.remove();
            }
            const modal = document.createElement('div');
            modal.id = id;
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.5s ease-in;
            `;
            if (!document.getElementById('modal-animations')) {
                const style = document.createElement('style');
                style.id = 'modal-animations';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideIn {
                        from { transform: translateY(-50px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    @keyframes subtleGlow {
                        0% { box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
                        50% { box-shadow: 0 20px 40px rgba(0,0,0,0.3), 0 0 30px rgba(40, 167, 69, 0.3); }
                        100% { box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
                    }
                `;
                document.head.appendChild(style);
            }
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                    color: white;
                    padding: 40px;
                    border-radius: 12px;
                    text-align: center;
                    max-width: 600px;
                    margin: 20px;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                    animation: slideIn 0.6s ease-out;
                    position: relative;
                    overflow: hidden;
                    border: 1px solid #495057;
                ">
                    <div style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        height: 4px;
                        background: linear-gradient(90deg, #28a745, #17a2b8, #007bff);
                        z-index: 1;
                    "></div>
                    <h1 style="font-size: 2.2em; margin: 0 0 20px 0; color: #e9ecef; font-weight: 300; letter-spacing: 1px;">
                        ${title}
                    </h1>
                    ${content}
                    <div style="margin-top: 30px;">
                        ${buttons}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            if (id.includes('celebration')) {
                // Add subtle glow animation for celebrations
                const modalContent = modal.querySelector('div');
                modalContent.style.animation = 'slideIn 0.6s ease-out, subtleGlow 3s ease-in-out infinite';
            }
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.animation = 'fadeIn 0.5s ease-in reverse';
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.remove();
                    }
                }, 500);
            }
        }

        function showIntroModal() {
            const title = 'ðŸ§© Welcome to the Listener Crossword Solver ðŸ§©';
            const content = `
                <div style="background: rgba(255,255,255,0.08);padding: 20px;border-radius: 8px;margin: 20px 0;border: 1px solid rgba(255,255,255,0.1);">
                    <h3 style="margin: 0 0 15px 0; color: #28a745; font-weight: 500; font-size: 1.3em;">The Prime Factor Challenge</h3>
                    <p style="margin: 0 0 15px 0; line-height: 1.6; color: #e9ecef;">
                        Welcome to the first stage of this mathematical crossword puzzle. 
                        Your goal is to fill in the grid with numbers that satisfy specific mathematical constraints.
                    </p>
                    <div style="background: rgba(40, 167, 69, 0.15);padding: 15px;border-radius: 8px;border-left: 4px solid #28a745;text-align: center;font-style: normal;color: #e9ecef;">
                        <strong style="color: #28a745;">How to Play:</strong><br>
                        â€¢ <strong>Clued entries</strong> in "a:b" format where a= no. of prime factors of solution and b= difference between largest and smallest factor<br>
                        â€¢ <strong>Unclued entries</strong> form an anagram of themselves in the final grid when multiplied by an integer<br>
                        â€¢ <strong>Mathematical Key:</strong> Look a key among the unclued entries - there's a special cyclic number that could be key to solving the puzzle
                    </div>
                </div>
                <div style="background: rgba(255,255,255,0.08);padding: 20px;border-radius: 8px;margin: 20px 0;border: 1px solid rgba(255,255,255,0.1);">
                    <h3 style="margin: 0 0 15px 0; color: #17a2b8; font-weight: 500; font-size: 1.3em;">Playing Tips</h3>
                    <ul style="margin: 0; padding-left: 0; list-style: none;">
                        <li style="text-align: center; margin-bottom: 8px; color: #e9ecef;">â€¢ Start with the clued entries to establish some constraints</li>
                        <li style="text-align: center; margin-bottom: 8px; color: #e9ecef;">â€¢ 'Think ahead' for the unclued entries</li>
                        <li style="text-align: center; margin-bottom: 8px; color: #e9ecef;">â€¢ Look for the mathematical key - a number with unique properties</li>
                        <li style="text-align: center; margin-bottom: 8px; color: #e9ecef;">â€¢ Use the factoring notepad (and the undo feature for mistakes...</li>
                    </ul>
                </div>
            `;
            const buttons = `
                <button onclick="hideModal('intro-modal')" style="background: linear-gradient(135deg, #28a745, #20c997);color: white;border: none;padding: 15px 30px;border-radius: 8px;font-size: 1.1em;font-weight: 500;cursor: pointer;transition: all 0.3s ease;box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(40, 167, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(40, 167, 69, 0.3)'">ðŸš€ Start Solving</button>
            `;
            createModal('intro-modal', title, content, buttons);
        }

        function showAnagramCompletionCelebration() {
            const title = 'ðŸ† Listener 4869 Completed ðŸ†';
            const content = `
                <div style="background: rgba(255,255,255,0.08);padding: 20px;border-radius: 8px;margin: 20px 0;border: 1px solid rgba(255,255,255,0.1);">
                    <h3 style="margin: 0 0 15px 0; color: #28a745; font-weight: 500; font-size: 1.3em;">Congratulations!</h3>
                    <p style="margin: 0 0 15px 0; line-height: 1.6; color: #e9ecef;">
                        You have successfully completed both stages of this ingenious mathematical puzzle. 
                        This is no small feat - it takes mathematical and logical insight to solve.
                    </p>
                </div>
                <div style="background: rgba(255,255,255,0.08);padding: 20px;border-radius: 8px;margin: 20px 0;border: 1px solid rgba(255,255,255,0.1);">
                    <h3 style="margin: 0 0 15px 0; color: #17a2b8; font-weight: 500; font-size: 1.3em;">The Mathematical Key...</h3>
                    <p style="margin: 0 0 15px 0; line-height: 1.6; color: #e9ecef;">
                        Did you discover the special cyclic number <strong style="color: #28a745;">142857</strong>? This remarkable number is a helpful key to the puzzle:
                    </p>
                    <div style="background: rgba(23, 162, 184, 0.15);padding: 15px;border-radius: 8px;border-left: 4px solid #17a2b8;text-align: center;font-style: normal;color: #e9ecef;">
                        <strong style="color: #17a2b8;">The Magic of 142857:</strong><br>
                        â€¢ 142857 Ã— 1 = 142857<br>
                        â€¢ 142857 Ã— 2 = 285714<br>
                        â€¢ 142857 Ã— 3 = 428571<br>
                        â€¢ 142857 Ã— 5 = 714285<br>
                        â€¢ 142857 Ã— 6 = 857142<br>
                        â€¢ 142857 Ã— 4 = 571428<br>
                        <br>
                        This cyclic property makes it perfect for the initial puzzle and the anagram grid.
                    </div>
                </div>
                <div style="background: rgba(255,255,255,0.08);padding: 20px;border-radius: 8px;margin: 20px 0;border: 1px solid rgba(255,255,255,0.1);">
                    <h3 style="margin: 0 0 15px 0; color: #6c757d; font-weight: 500; font-size: 1.3em;">Your Solving Journey</h3>
                    <p style="margin: 0 0 15px 0; line-height: 1.6; color: #e9ecef;">
                        Whether you found this through mathematical insight, systematic trial and error, or a bit of luck, 
                        you've demonstrated tenacity and strong problem-solving skills.
                    </p>
                    <p style="margin: 0 0 15px 0; line-height: 1.6; font-style: italic; color: #adb5bd;">
                        "The value of a problem is not so much coming up with the answer as in the ideas it forces on the solver." - Andrew Wiles
                    </p>
                </div>
            `;
            const buttons = `
                <button onclick="hideModal('anagram-completion-celebration')" style="background: linear-gradient(135deg, #6c757d, #495057);color: white;border: none;padding: 15px 30px;border-radius: 8px;font-size: 1.1em;font-weight: 500;cursor: pointer;transition: all 0.3s ease;box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(108, 117, 125, 0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(108, 117, 125, 0.3)'">ðŸŽ‰ Now take a well-earned break! ðŸŽ‰</button>
            `;
            createModal('anagram-completion-celebration', title, content, buttons);
        }

        function createConfetti() {
            // Removed confetti for sophisticated design
            // The subtle glow animation provides sufficient celebration effect
        }
        
        // Iframe communication for Flask app integration
        window.addEventListener('message', function(event) {
            console.log('Received message from parent:', event.data);
            
            if (event.data.action === 'save_state') {
                console.log('Save state requested by parent');
                
                // Send state back to parent (including anagram state)
                window.parent.postMessage({
                    action: 'save_state_request',
                    state: {
                        solved_cells: solvedCells,
                        user_selected_solutions: Array.from(userSelectedSolutions),
                        solution_history: solutionHistory,
                        anagram_solved_cells: anagramSolvedCells,
                        anagram_user_selected_solutions: Array.from(anagramUserSelectedSolutions),
                        anagram_clue_objects: anagramClueObjects
                    }
                }, '*');
            }
            else if (event.data.action === 'load_state') {
                console.log('Load state requested by parent');
                
                // Request state from parent
                window.parent.postMessage({
                    action: 'load_state_request'
                }, '*');
            }
            else if (event.data.action === 'load_state_response') {
                console.log('Load state response received:', event.data.state);
                
                // Apply loaded state (including anagram state)
                const state = event.data.state;
                solvedCells = state.solved_cells || {};
                userSelectedSolutions = new Set(state.user_selected_solutions || []);
                solutionHistory = state.solution_history || [];
                
                // Load anagram state
                anagramSolvedCells = state.anagram_solved_cells || {};
                anagramUserSelectedSolutions = new Set(state.anagram_user_selected_solutions || []);
                anagramClueObjects = state.anagram_clue_objects || {};
                
                // Update UI
                updateGridDisplay();
                updateAllClueDisplays();
                updateProgress();
                updateUndoButton();
                
                // Update anagram grid if anagram state exists
                if (Object.keys(anagramSolvedCells).length > 0 || Object.keys(anagramClueObjects).length > 0) {
                    // Update anagram grid display
                    for (const [cellIndex, digit] of Object.entries(anagramSolvedCells)) {
                        updateAnagramCellDisplay(parseInt(cellIndex), digit);
                    }
                    
                    // Update anagram clue displays
                    updateAnagramClueDisplays();
                    
                    // Show anagram grid section
                    const anagramGridSection = document.getElementById('anagram-grid-section');
                    if (anagramGridSection) {
                        anagramGridSection.style.display = 'block';
                    }
                    
                    // Show anagram clues if they exist
                    if (Object.keys(anagramClueObjects).length > 0) {
                        generateAnagramCluesHTMLFromObjects();
                        
                        const initialCluesContainer = document.getElementById('initial-clues-container');
                        const anagramCluesContainer = document.getElementById('anagram-clues-container');
                        if (initialCluesContainer) {
                            initialCluesContainer.style.display = 'none';
                        }
                        if (anagramCluesContainer) {
                            anagramCluesContainer.style.display = 'block';
                        }
                    }
                }
                
                showNotification('State loaded successfully!', 'success');
            }
            else if (event.data.action === 'test_communication') {
                console.log('Test communication received');
                
                // Send test response back
                window.parent.postMessage({
                    action: 'test_response',
                    message: 'Iframe communication working!'
                }, '*');
            }
        });

        function factorizeNumber() {
            const input = document.getElementById('workpad-number');
            const resultDiv = document.getElementById('factorization-result');
            const statsDiv = document.getElementById('factorization-stats');
            const number = parseInt(input.value);
            if (!number || number <= 0) {
                resultDiv.innerHTML = '<div style="color: #dc3545;">Please enter a positive number</div>';
                statsDiv.style.display = 'none';
                return;
            }
            const factorization = getPrimeFactorization(number);
            const stats = getPrimeFactorStats(number);
            resultDiv.innerHTML = `<div style="font-weight: bold; margin-bottom: 8px;">${factorization}</div>`;
            statsDiv.innerHTML = `
                <strong>Factors:</strong><br>
                â€¢ Number of factors: ${stats.count}<br>
                â€¢ Smallest factor: ${stats.min_factor}<br>
                â€¢ Largest factor: ${stats.max_factor}<br>
                â€¢ Difference: ${stats.difference}<br>
                <br>
                <strong>Clue:</strong> <strong>${stats.count}:${stats.difference}</strong>
            `;
            statsDiv.style.display = 'block';
        }

        function clearWorkpad() {
            document.getElementById('workpad-number').value = '';
            document.getElementById('factorization-result').innerHTML = '<div style="color: #6c757d; font-style: italic;">Enter a number above to see its prime factorization</div>';
            document.getElementById('factorization-stats').style.display = 'none';
        }

        function getPrimeFactorization(number) {
            if (number <= 1) return `${number} (no prime factors)`;
            const factors = [];
            let n = number;
            while (n % 2 === 0) {
                factors.push(2);
                n = n / 2;
            }
            for (let i = 3; i <= Math.sqrt(n); i += 2) {
                while (n % i === 0) {
                    factors.push(i);
                    n = n / i;
                }
            }
            if (n > 2) {
                factors.push(n);
            }
            if (factors.length === 0) {
                return `${number} (prime)`;
            }
            const factorCounts = {};
            for (const factor of factors) {
                factorCounts[factor] = (factorCounts[factor] || 0) + 1;
            }
            const factorParts = [];
            for (const [factor, count] of Object.entries(factorCounts).sort((a, b) => parseInt(a[0]) - parseInt(b[0]))) {
                if (count === 1) {
                    factorParts.push(factor);
                } else {
                    factorParts.push(`${factor}^${count}`);
                }
            }
            return `${number} = ${factorParts.join(' Ã— ')}`;
        }

        function getPrimeFactorStats(number) {
            if (number <= 1) {
                return {
                    count: 0,
                    min_factor: null,
                    max_factor: null,
                    difference: null,
                    is_prime: number > 1
                };
            }
            const factors = [];
            let n = number;
            while (n % 2 === 0) {
                factors.push(2);
                n = n / 2;
            }
            for (let i = 3; i <= Math.sqrt(n); i += 2) {
                while (n % i === 0) {
                    factors.push(i);
                    n = n / i;
                }
            }
            if (n > 2) {
                factors.push(n);
            }
            if (factors.length === 0) {
                return {
                    count: 0,
                    min_factor: number,
                    max_factor: number,
                    difference: 0,
                    is_prime: true
                };
            }
            return {
                count: factors.length,
                min_factor: Math.min(...factors),
                max_factor: Math.max(...factors),
                difference: Math.max(...factors) - Math.min(...factors),
                is_prime: false
            };
        }
    </script>
</body>
</html>