<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Crossword Solver</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
        }
        
        .header h1 {
            color: #333;
            margin: 0;
        }
        
        .main-content {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            position: relative;
        }
        
        .grid-section {
            flex: 1;
        }
        
        .info-section {
            flex: 1;
            min-width: 400px;
        }
        
        .crossword-grid {
            display: inline-block;
            border: 3px solid #333;
            background-color: #333;
        }
        
        .grid-row {
            display: flex;
        }
        
        .grid-cell {
            width: 50px;
            height: 50px;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            font-weight: bold;
            font-size: 18px;
            box-sizing: border-box;
            border-right: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
        }
        
        .grid-clue-number {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 10px;
            color: #666;
            font-weight: normal;
        }
        
        .cell-value {
            font-size: 20px;
            color: #333;
        }
        
        .grid-cell:nth-child(8n) {
            border-right: none;
        }
        
        .grid-row:last-child .grid-cell {
            border-bottom: none;
        }
        
        .thick-right {
            border-right: 3px solid #333 !important;
        }
        
        .thick-bottom {
            border-bottom: 3px solid #333 !important;
        }
        
        .thick-left {
            border-left: 3px solid #333 !important;
        }
        
        .thick-top {
            border-top: 3px solid #333 !important;
        }
        
        .clues-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .clues-column {
            flex: 1;
        }
        
        .clues-column h3 {
            color: #333;
            border-bottom: 2px solid #333;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        
        .clue {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
            background-color: #f9f9f9;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 2px solid transparent;
        }
        
        .clue:hover {
            background-color: #e9e9e9;
        }
        
        .clue.solved {
            background-color: #d4edda;
            color: #155724;
            font-weight: bold;
        }
        
        .clue.user-selected {
            background-color: #cce5ff;
            color: #004085;
            font-weight: bold;
            border-left: 4px solid #007bff;
        }
        
        .clue.algorithm-solved {
            background-color: #d1ecf1;
            color: #0c5460;
            font-weight: bold;
            border-left: 4px solid #17a2b8;
        }
        
        .clue.multiple {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .clue.unclued {
            background-color: #f8d7da;
            color: #721c24;
            font-style: italic;
        }
        
        .clue-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .clue-header .clue-number {
            font-weight: normal;
            min-width: 20px;
            color: #888;
            font-size: 13px;
            flex-shrink: 0;
        }
        
        .clue-text {
            flex: 1;
            margin-left: 8px;
            font-weight: bold;
            font-size: 16px;
            color: #222;
        }
        
        .solution-count {
            font-size: 12px;
            color: #666;
            text-align: right;
            flex-shrink: 0;
            min-width: 90px;
        }
        
        .solution-dropdown {
            margin-top: 8px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .solution-select {
            width: 100%;
            padding: 4px;
            margin-bottom: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .solution-text-input {
            width: 100%;
            padding: 4px;
            margin-bottom: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .apply-solution {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .apply-solution:hover {
            background-color: #0056b3;
        }
        
        .apply-solution:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .progress-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        
        .progress-section h3 {
            margin-top: 0;
            color: #333;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }
        
        .progress-stats {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }
        
        .notification {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 400px;
            max-width: 45%;
            padding: 15px;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            text-align: center;
        }
        
        .notification.success {
            background-color: #28a745;
        }
        
        .notification.error {
            background-color: #dc3545;
        }
        
        .notification.info {
            background-color: #17a2b8;
        }
        
        .undo-section {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 6px;
            text-align: center;
        }
        
        .undo-button {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        
        .undo-button:hover {
            background-color: #5a6268;
        }
        
        .undo-button:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
        }
        
        .history-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Interactive Crossword Solver</h1>
            <div class="timestamp">Listener 4869, 24 May 2025</div>
        </div>

        <div class="main-content">
            <div class="grid-section">
                <h3>Puzzle Grid</h3>
                <div class="crossword-grid">
  <div class="grid-row">
    <div class="grid-cell " data-cell="0"><div class="grid-clue-number">1</div></div>
    <div class="grid-cell " data-cell="1"><div class="grid-clue-number">2</div></div>
    <div class="grid-cell " data-cell="2"><div class="grid-clue-number">3</div></div>
    <div class="grid-cell thick-right" data-cell="3"></div>
    <div class="grid-cell " data-cell="4"><div class="grid-clue-number">4</div></div>
    <div class="grid-cell " data-cell="5"><div class="grid-clue-number">5</div></div>
    <div class="grid-cell " data-cell="6"></div>
    <div class="grid-cell " data-cell="7"><div class="grid-clue-number">6</div></div>
  </div>
  <div class="grid-row">
    <div class="grid-cell " data-cell="8"></div>
    <div class="grid-cell thick-right thick-bottom thick-left" data-cell="9"></div>
    <div class="grid-cell " data-cell="10"></div>
    <div class="grid-cell thick-right thick-left thick-top" data-cell="11"><div class="grid-clue-number">7</div></div>
    <div class="grid-cell thick-right thick-top" data-cell="12"><div class="grid-clue-number">8</div></div>
    <div class="grid-cell " data-cell="13"></div>
    <div class="grid-cell thick-bottom thick-left thick-top" data-cell="14"><div class="grid-clue-number">9</div></div>
    <div class="grid-cell " data-cell="15"></div>
  </div>
  <div class="grid-row">
    <div class="grid-cell " data-cell="16"><div class="grid-clue-number">10</div></div>
    <div class="grid-cell " data-cell="17"></div>
    <div class="grid-cell " data-cell="18"></div>
    <div class="grid-cell thick-right" data-cell="19"></div>
    <div class="grid-cell " data-cell="20"><div class="grid-clue-number">11</div></div>
    <div class="grid-cell " data-cell="21"></div>
    <div class="grid-cell " data-cell="22"></div>
    <div class="grid-cell " data-cell="23"></div>
  </div>
  <div class="grid-row">
    <div class="grid-cell thick-bottom" data-cell="24"></div>
    <div class="grid-cell thick-bottom thick-left thick-top" data-cell="25"><div class="grid-clue-number">12</div></div>
    <div class="grid-cell thick-bottom" data-cell="26"></div>
    <div class="grid-cell " data-cell="27"></div>
    <div class="grid-cell " data-cell="28"></div>
    <div class="grid-cell thick-bottom" data-cell="29"></div>
    <div class="grid-cell thick-right thick-bottom thick-top" data-cell="30"></div>
    <div class="grid-cell thick-bottom" data-cell="31"></div>
  </div>
  <div class="grid-row">
    <div class="grid-cell " data-cell="32"><div class="grid-clue-number">13</div></div>
    <div class="grid-cell thick-bottom thick-left" data-cell="33"><div class="grid-clue-number">14</div></div>
    <div class="grid-cell " data-cell="34"><div class="grid-clue-number">15</div></div>
    <div class="grid-cell " data-cell="35"></div>
    <div class="grid-cell " data-cell="36"></div>
    <div class="grid-cell " data-cell="37"><div class="grid-clue-number">16</div></div>
    <div class="grid-cell thick-right thick-bottom" data-cell="38"></div>
    <div class="grid-cell " data-cell="39"><div class="grid-clue-number">17</div></div>
  </div>
  <div class="grid-row">
    <div class="grid-cell " data-cell="40"><div class="grid-clue-number">18</div></div>
    <div class="grid-cell " data-cell="41"></div>
    <div class="grid-cell " data-cell="42"></div>
    <div class="grid-cell thick-right" data-cell="43"></div>
    <div class="grid-cell " data-cell="44"><div class="grid-clue-number">19</div></div>
    <div class="grid-cell " data-cell="45"></div>
    <div class="grid-cell " data-cell="46"></div>
    <div class="grid-cell " data-cell="47"></div>
  </div>
  <div class="grid-row">
    <div class="grid-cell " data-cell="48"><div class="grid-clue-number">20</div></div>
    <div class="grid-cell thick-right thick-bottom thick-top" data-cell="49"></div>
    <div class="grid-cell " data-cell="50"></div>
    <div class="grid-cell thick-right thick-bottom thick-left" data-cell="51"></div>
    <div class="grid-cell thick-right thick-bottom" data-cell="52"></div>
    <div class="grid-cell " data-cell="53"></div>
    <div class="grid-cell thick-right thick-left thick-top" data-cell="54"><div class="grid-clue-number">21</div></div>
    <div class="grid-cell " data-cell="55"></div>
  </div>
  <div class="grid-row">
    <div class="grid-cell " data-cell="56"><div class="grid-clue-number">22</div></div>
    <div class="grid-cell " data-cell="57"></div>
    <div class="grid-cell " data-cell="58"></div>
    <div class="grid-cell thick-right" data-cell="59"></div>
    <div class="grid-cell " data-cell="60"><div class="grid-clue-number">23</div></div>
    <div class="grid-cell " data-cell="61"></div>
    <div class="grid-cell " data-cell="62"></div>
    <div class="grid-cell " data-cell="63"></div>
  </div>
</div>
            </div>
            
            <div class="info-section">
                <div class="clues-section">
  <div class="clues-column">
    <h3>Across</h3>
    <div class="clue multiple" data-clue="1_ACROSS">
      <div class="clue-header">
        <span class="clue-number">1.</span>
        <span class="clue-text">6:2</span>
        <span class="solution-count">(5 solutions)</span>
      </div>
      <div class="solution-dropdown" id="dropdown-1_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="1_ACROSS">
          <option value="">-- Select a solution --</option>
          <option value="1215">1215</option>
          <option value="2025">2025</option>
          <option value="3375">3375</option>
          <option value="5625">5625</option>
          <option value="9375">9375</option>
        </select>
        <button class="apply-solution" data-clue="1_ACROSS">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="4_ACROSS">
      <div class="clue-header">
        <span class="clue-number">4.</span>
        <span class="clue-text">3:69</span>
        <span class="solution-count">(15 solutions)</span>
      </div>
      <div class="solution-dropdown" id="dropdown-4_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="4_ACROSS">
          <option value="">-- Select a solution --</option>
          <option value="6106">6106</option>
          <option value="3266">3266</option>
          <option value="5254">5254</option>
          <option value="7526">7526</option>
          <option value="8378">8378</option>
          <option value="2698">2698</option>
          <option value="9514">9514</option>
          <option value="2414">2414</option>
          <option value="4402">4402</option>
          <option value="6674">6674</option>
          <option value="1846">1846</option>
          <option value="4118">4118</option>
          <option value="8662">8662</option>
          <option value="1562">1562</option>
          <option value="5822">5822</option>
        </select>
        <button class="apply-solution" data-clue="4_ACROSS">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="9_ACROSS">
      <div class="clue-header">
        <span class="clue-number">9.</span>
        <span class="clue-text">5:1</span>
        <span class="solution-count">(2 solutions)</span>
      </div>
      <div class="solution-dropdown" id="dropdown-9_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="9_ACROSS">
          <option value="">-- Select a solution --</option>
          <option value="48">48</option>
          <option value="72">72</option>
        </select>
        <button class="apply-solution" data-clue="9_ACROSS">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="10_ACROSS">
      <div class="clue-header">
        <span class="clue-number">10.</span>
        <span class="clue-text">3:104</span>
        <span class="solution-count">(14 solutions)</span>
      </div>
      <div class="solution-dropdown" id="dropdown-10_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="10_ACROSS">
          <option value="">-- Select a solution --</option>
          <option value="1605">1605</option>
          <option value="2725">2725</option>
          <option value="3815">3815</option>
          <option value="2247">2247</option>
          <option value="3531">3531</option>
          <option value="5995">5995</option>
          <option value="4173">4173</option>
          <option value="7085">7085</option>
          <option value="5457">5457</option>
          <option value="9265">9265</option>
          <option value="6099">6099</option>
          <option value="7383">7383</option>
          <option value="9309">9309</option>
          <option value="9951">9951</option>
        </select>
        <button class="apply-solution" data-clue="10_ACROSS">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="11_ACROSS">
      <div class="clue-header">
        <span class="clue-number">11.</span>
        <span class="clue-text">4:11</span>
        <span class="solution-count">(9 solutions)</span>
      </div>
      <div class="solution-dropdown" id="dropdown-11_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="11_ACROSS">
          <option value="">-- Select a solution --</option>
          <option value="3718">3718</option>
          <option value="3146">3146</option>
          <option value="4394">4394</option>
          <option value="2002">2002</option>
          <option value="1690">1690</option>
          <option value="1430">1430</option>
          <option value="1014">1014</option>
          <option value="1274">1274</option>
          <option value="2366">2366</option>
        </select>
        <button class="apply-solution" data-clue="11_ACROSS">Apply</button>
      </div>
    </div>
    <div class="clue unclued" data-clue="12_ACROSS">
      <div class="clue-header">
        <span class="clue-number">12.</span>
        <span class="clue-text">Unclued</span>
      </div>
      <div class="solution-input" id="input-12_ACROSS" style="display: none;">
        <input type="text" class="solution-text-input" data-clue="12_ACROSS" placeholder="Enter 6-digit solution" maxlength="6">
        <button class="apply-solution" data-clue="12_ACROSS">Apply</button>
        <span class="unclued-error" id="error-12_ACROSS" style="color: #b00; margin-left: 8px; display: none;"></span>
      </div>
    </div>
    <div class="clue unclued" data-clue="14_ACROSS">
      <div class="clue-header">
        <span class="clue-number">14.</span>
        <span class="clue-text">Unclued</span>
      </div>
      <div class="solution-input" id="input-14_ACROSS" style="display: none;">
        <input type="text" class="solution-text-input" data-clue="14_ACROSS" placeholder="Enter 6-digit solution" maxlength="6">
        <button class="apply-solution" data-clue="14_ACROSS">Apply</button>
        <span class="unclued-error" id="error-14_ACROSS" style="color: #b00; margin-left: 8px; display: none;"></span>
      </div>
    </div>
    <div class="clue " data-clue="18_ACROSS">
      <div class="clue-header">
        <span class="clue-number">18.</span>
        <span class="clue-text">10:0</span>
        <span class="solution-count">(1 solutions)</span>
      </div>
      <div class="solution-dropdown" id="dropdown-18_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="18_ACROSS">
          <option value="">-- Select a solution --</option>
          <option value="1024">1024</option>
        </select>
        <button class="apply-solution" data-clue="18_ACROSS">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="19_ACROSS">
      <div class="clue-header">
        <span class="clue-number">19.</span>
        <span class="clue-text">7:9</span>
        <span class="solution-count">(24 solutions)</span>
      </div>
      <div class="solution-dropdown" id="dropdown-19_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="19_ACROSS">
          <option value="">-- Select a solution --</option>
          <option value="8712">8712</option>
          <option value="6160">6160</option>
          <option value="9240">9240</option>
          <option value="1056">1056</option>
          <option value="2464">2464</option>
          <option value="3872">3872</option>
          <option value="5544">5544</option>
          <option value="9900">9900</option>
          <option value="1584">1584</option>
          <option value="4400">4400</option>
          <option value="5808">5808</option>
          <option value="8624">8624</option>
          <option value="5940">5940</option>
          <option value="2376">2376</option>
          <option value="6600">6600</option>
          <option value="8910">8910</option>
          <option value="2640">2640</option>
          <option value="9680">9680</option>
          <option value="1760">1760</option>
          <option value="5346">5346</option>
          <option value="3564">3564</option>
          <option value="3696">3696</option>
          <option value="3960">3960</option>
          <option value="8316">8316</option>
        </select>
        <button class="apply-solution" data-clue="19_ACROSS">Apply</button>
      </div>
    </div>
    <div class="clue " data-clue="20_ACROSS">
      <div class="clue-header">
        <span class="clue-number">20.</span>
        <span class="clue-text">5:0</span>
        <span class="solution-count">(1 solutions)</span>
      </div>
      <div class="solution-dropdown" id="dropdown-20_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="20_ACROSS">
          <option value="">-- Select a solution --</option>
          <option value="32">32</option>
        </select>
        <button class="apply-solution" data-clue="20_ACROSS">Apply</button>
      </div>
    </div>
    <div class="clue " data-clue="22_ACROSS">
      <div class="clue-header">
        <span class="clue-number">22.</span>
        <span class="clue-text">2:1427</span>
        <span class="solution-count">(1 solutions)</span>
      </div>
      <div class="solution-dropdown" id="dropdown-22_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="22_ACROSS">
          <option value="">-- Select a solution --</option>
          <option value="2858">2858</option>
        </select>
        <button class="apply-solution" data-clue="22_ACROSS">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="23_ACROSS">
      <div class="clue-header">
        <span class="clue-number">23.</span>
        <span class="clue-text">6:4</span>
        <span class="solution-count">(7 solutions)</span>
      </div>
      <div class="solution-dropdown" id="dropdown-23_ACROSS" style="display: none;">
        <select class="solution-select" data-clue="23_ACROSS">
          <option value="">-- Select a solution --</option>
          <option value="3969">3969</option>
          <option value="7875">7875</option>
          <option value="1701">1701</option>
          <option value="9261">9261</option>
          <option value="2835">2835</option>
          <option value="4725">4725</option>
          <option value="6615">6615</option>
        </select>
        <button class="apply-solution" data-clue="23_ACROSS">Apply</button>
      </div>
    </div>
  </div>
  <div class="clues-column">
    <h3>Down</h3>
    <div class="clue multiple" data-clue="1_DOWN">
      <div class="clue-header">
        <span class="clue-number">1.</span>
        <span class="clue-text">4:16</span>
        <span class="solution-count">(20 solutions)</span>
      </div>
      <div class="solution-dropdown" id="dropdown-1_DOWN" style="display: none;">
        <select class="solution-select" data-clue="1_DOWN">
          <option value="">-- Select a solution --</option>
          <option value="1425">1425</option>
          <option value="7581">7581</option>
          <option value="9633">9633</option>
          <option value="4389">4389</option>
          <option value="5415">5415</option>
          <option value="1197">1197</option>
          <option value="2223">2223</option>
          <option value="3249">3249</option>
          <option value="3135">3135</option>
          <option value="5187">5187</option>
          <option value="1995">1995</option>
          <option value="7889">7889</option>
          <option value="8151">8151</option>
          <option value="1881">1881</option>
          <option value="2907">2907</option>
          <option value="2793">2793</option>
          <option value="4845">4845</option>
          <option value="6897">6897</option>
          <option value="3705">3705</option>
          <option value="6783">6783</option>
        </select>
        <button class="apply-solution" data-clue="1_DOWN">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="2_DOWN">
      <div class="clue-header">
        <span class="clue-number">2.</span>
        <span class="clue-text">2:2</span>
        <span class="solution-count">(2 solutions)</span>
      </div>
      <div class="solution-dropdown" id="dropdown-2_DOWN" style="display: none;">
        <select class="solution-select" data-clue="2_DOWN">
          <option value="">-- Select a solution --</option>
          <option value="35">35</option>
          <option value="15">15</option>
        </select>
        <button class="apply-solution" data-clue="2_DOWN">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="3_DOWN">
      <div class="clue-header">
        <span class="clue-number">3.</span>
        <span class="clue-text">10:1</span>
        <span class="solution-count">(5 solutions)</span>
      </div>
      <div class="solution-dropdown" id="dropdown-3_DOWN" style="display: none;">
        <select class="solution-select" data-clue="3_DOWN">
          <option value="">-- Select a solution --</option>
          <option value="1536">1536</option>
          <option value="2304">2304</option>
          <option value="5184">5184</option>
          <option value="7776">7776</option>
          <option value="3456">3456</option>
        </select>
        <button class="apply-solution" data-clue="3_DOWN">Apply</button>
      </div>
    </div>
    <div class="clue " data-clue="5_DOWN">
      <div class="clue-header">
        <span class="clue-number">5.</span>
        <span class="clue-text">11:0</span>
        <span class="solution-count">(1 solutions)</span>
      </div>
      <div class="solution-dropdown" id="dropdown-5_DOWN" style="display: none;">
        <select class="solution-select" data-clue="5_DOWN">
          <option value="">-- Select a solution --</option>
          <option value="2048">2048</option>
        </select>
        <button class="apply-solution" data-clue="5_DOWN">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="6_DOWN">
      <div class="clue-header">
        <span class="clue-number">6.</span>
        <span class="clue-text">2:594</span>
        <span class="solution-count">(3 solutions)</span>
      </div>
      <div class="solution-dropdown" id="dropdown-6_DOWN" style="display: none;">
        <select class="solution-select" data-clue="6_DOWN">
          <option value="">-- Select a solution --</option>
          <option value="2995">2995</option>
          <option value="7891">7891</option>
          <option value="4207">4207</option>
        </select>
        <button class="apply-solution" data-clue="6_DOWN">Apply</button>
      </div>
    </div>
    <div class="clue unclued" data-clue="7_DOWN">
      <div class="clue-header">
        <span class="clue-number">7.</span>
        <span class="clue-text">Unclued</span>
      </div>
      <div class="solution-input" id="input-7_DOWN" style="display: none;">
        <input type="text" class="solution-text-input" data-clue="7_DOWN" placeholder="Enter 6-digit solution" maxlength="6">
        <button class="apply-solution" data-clue="7_DOWN">Apply</button>
        <span class="unclued-error" id="error-7_DOWN" style="color: #b00; margin-left: 8px; display: none;"></span>
      </div>
    </div>
    <div class="clue unclued" data-clue="8_DOWN">
      <div class="clue-header">
        <span class="clue-number">8.</span>
        <span class="clue-text">Unclued</span>
      </div>
      <div class="solution-input" id="input-8_DOWN" style="display: none;">
        <input type="text" class="solution-text-input" data-clue="8_DOWN" placeholder="Enter 6-digit solution" maxlength="6">
        <button class="apply-solution" data-clue="8_DOWN">Apply</button>
        <span class="unclued-error" id="error-8_DOWN" style="color: #b00; margin-left: 8px; display: none;"></span>
      </div>
    </div>
    <div class="clue multiple" data-clue="13_DOWN">
      <div class="clue-header">
        <span class="clue-number">13.</span>
        <span class="clue-text">3:1281</span>
        <span class="solution-count">(2 solutions)</span>
      </div>
      <div class="solution-dropdown" id="dropdown-13_DOWN" style="display: none;">
        <select class="solution-select" data-clue="13_DOWN">
          <option value="">-- Select a solution --</option>
          <option value="7698">7698</option>
          <option value="5132">5132</option>
        </select>
        <button class="apply-solution" data-clue="13_DOWN">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="15_DOWN">
      <div class="clue-header">
        <span class="clue-number">15.</span>
        <span class="clue-text">4:8</span>
        <span class="solution-count">(15 solutions)</span>
      </div>
      <div class="solution-dropdown" id="dropdown-15_DOWN" style="display: none;">
        <select class="solution-select" data-clue="15_DOWN">
          <option value="">-- Select a solution --</option>
          <option value="1089">1089</option>
          <option value="4225">4225</option>
          <option value="1155">1155</option>
          <option value="2275">2275</option>
          <option value="3575">3575</option>
          <option value="2541">2541</option>
          <option value="5005">5005</option>
          <option value="9295">9295</option>
          <option value="1617">1617</option>
          <option value="3185">3185</option>
          <option value="7865">7865</option>
          <option value="1815">1815</option>
          <option value="1625">1625</option>
          <option value="3993">3993</option>
          <option value="5915">5915</option>
        </select>
        <button class="apply-solution" data-clue="15_DOWN">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="16_DOWN">
      <div class="clue-header">
        <span class="clue-number">16.</span>
        <span class="clue-text">4:29</span>
        <span class="solution-count">(32 solutions)</span>
      </div>
      <div class="solution-dropdown" id="dropdown-16_DOWN" style="display: none;">
        <select class="solution-select" data-clue="16_DOWN">
          <option value="">-- Select a solution --</option>
          <option value="5890">5890</option>
          <option value="3844">3844</option>
          <option value="5766">5766</option>
          <option value="5642">5642</option>
          <option value="9610">9610</option>
          <option value="3596">3596</option>
          <option value="1550">1550</option>
          <option value="5394">5394</option>
          <option value="1302">1302</option>
          <option value="5270">5270</option>
          <option value="8990">8990</option>
          <option value="8866">8866</option>
          <option value="2852">2852</option>
          <option value="4774">4774</option>
          <option value="9982">9982</option>
          <option value="2356">2356</option>
          <option value="4278">4278</option>
          <option value="8246">8246</option>
          <option value="2108">2108</option>
          <option value="4030">4030</option>
          <option value="1612">1612</option>
          <option value="3534">3534</option>
          <option value="7502">7502</option>
          <option value="3410">3410</option>
          <option value="7378">7378</option>
          <option value="1364">1364</option>
          <option value="3162">3162</option>
          <option value="7130">7130</option>
          <option value="3038">3038</option>
          <option value="2418">2418</option>
          <option value="2170">2170</option>
          <option value="2046">2046</option>
        </select>
        <button class="apply-solution" data-clue="16_DOWN">Apply</button>
      </div>
    </div>
    <div class="clue " data-clue="17_DOWN">
      <div class="clue-header">
        <span class="clue-number">17.</span>
        <span class="clue-text">4:0</span>
        <span class="solution-count">(1 solutions)</span>
      </div>
      <div class="solution-dropdown" id="dropdown-17_DOWN" style="display: none;">
        <select class="solution-select" data-clue="17_DOWN">
          <option value="">-- Select a solution --</option>
          <option value="2401">2401</option>
        </select>
        <button class="apply-solution" data-clue="17_DOWN">Apply</button>
      </div>
    </div>
    <div class="clue multiple" data-clue="21_DOWN">
      <div class="clue-header">
        <span class="clue-number">21.</span>
        <span class="clue-text">4:0</span>
        <span class="solution-count">(2 solutions)</span>
      </div>
      <div class="solution-dropdown" id="dropdown-21_DOWN" style="display: none;">
        <select class="solution-select" data-clue="21_DOWN">
          <option value="">-- Select a solution --</option>
          <option value="16">16</option>
          <option value="81">81</option>
        </select>
        <button class="apply-solution" data-clue="21_DOWN">Apply</button>
      </div>
    </div>
  </div>
</div>
                
                <div class="progress-section">
                    <h3>Progress</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="progress-stats">
                        <div>Cells filled: 0/64 (0.0%)</div>
                        <div>Clues solved: 0/24</div>
                    </div>
                </div>
                
                <div class="undo-section">
                    <h3>Solution History</h3>
                    <button class="undo-button" id="undo-button" disabled>Undo Last Solution</button>
                    <div class="history-info" id="history-info">No solutions applied yet</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Interactive functionality
        let solvedCells = {};
        let clueObjects = {"1_ACROSS": {"number": 1, "direction": "ACROSS", "cell_indices": [0, 1, 2, 3], "length": 4, "is_unclued": false, "possible_solutions": [1215, 2025, 3375, 5625, 9375], "original_solution_count": 5}, "1_DOWN": {"number": 1, "direction": "DOWN", "cell_indices": [0, 8, 16, 24], "length": 4, "is_unclued": false, "possible_solutions": [1425, 7581, 9633, 4389, 5415, 1197, 2223, 3249, 3135, 5187, 1995, 7889, 8151, 1881, 2907, 2793, 4845, 6897, 3705, 6783], "original_solution_count": 20}, "2_DOWN": {"number": 2, "direction": "DOWN", "cell_indices": [1, 9], "length": 2, "is_unclued": false, "possible_solutions": [35, 15], "original_solution_count": 2}, "3_DOWN": {"number": 3, "direction": "DOWN", "cell_indices": [2, 10, 18, 26], "length": 4, "is_unclued": false, "possible_solutions": [1536, 2304, 5184, 7776, 3456], "original_solution_count": 5}, "4_ACROSS": {"number": 4, "direction": "ACROSS", "cell_indices": [4, 5, 6, 7], "length": 4, "is_unclued": false, "possible_solutions": [6106, 3266, 5254, 7526, 8378, 2698, 9514, 2414, 4402, 6674, 1846, 4118, 8662, 1562, 5822], "original_solution_count": 15}, "5_DOWN": {"number": 5, "direction": "DOWN", "cell_indices": [5, 13, 21, 29], "length": 4, "is_unclued": false, "possible_solutions": [2048], "original_solution_count": 1}, "6_DOWN": {"number": 6, "direction": "DOWN", "cell_indices": [7, 15, 23, 31], "length": 4, "is_unclued": false, "possible_solutions": [2995, 7891, 4207], "original_solution_count": 3}, "7_DOWN": {"number": 7, "direction": "DOWN", "cell_indices": [11, 19, 27, 35, 43, 51], "length": 6, "is_unclued": true, "possible_solutions": [], "original_solution_count": 0}, "8_DOWN": {"number": 8, "direction": "DOWN", "cell_indices": [12, 20, 28, 36, 44, 52], "length": 6, "is_unclued": true, "possible_solutions": [], "original_solution_count": 0}, "9_ACROSS": {"number": 9, "direction": "ACROSS", "cell_indices": [14, 15], "length": 2, "is_unclued": false, "possible_solutions": [48, 72], "original_solution_count": 2}, "10_ACROSS": {"number": 10, "direction": "ACROSS", "cell_indices": [16, 17, 18, 19], "length": 4, "is_unclued": false, "possible_solutions": [1605, 2725, 3815, 2247, 3531, 5995, 4173, 7085, 5457, 9265, 6099, 7383, 9309, 9951], "original_solution_count": 14}, "11_ACROSS": {"number": 11, "direction": "ACROSS", "cell_indices": [20, 21, 22, 23], "length": 4, "is_unclued": false, "possible_solutions": [3718, 3146, 4394, 2002, 1690, 1430, 1014, 1274, 2366], "original_solution_count": 9}, "12_ACROSS": {"number": 12, "direction": "ACROSS", "cell_indices": [25, 26, 27, 28, 29, 30], "length": 6, "is_unclued": true, "possible_solutions": [], "original_solution_count": 0}, "13_DOWN": {"number": 13, "direction": "DOWN", "cell_indices": [32, 40, 48, 56], "length": 4, "is_unclued": false, "possible_solutions": [7698, 5132], "original_solution_count": 2}, "14_ACROSS": {"number": 14, "direction": "ACROSS", "cell_indices": [33, 34, 35, 36, 37, 38], "length": 6, "is_unclued": true, "possible_solutions": [], "original_solution_count": 0}, "15_DOWN": {"number": 15, "direction": "DOWN", "cell_indices": [34, 42, 50, 58], "length": 4, "is_unclued": false, "possible_solutions": [1089, 4225, 1155, 2275, 3575, 2541, 5005, 9295, 1617, 3185, 7865, 1815, 1625, 3993, 5915], "original_solution_count": 15}, "16_DOWN": {"number": 16, "direction": "DOWN", "cell_indices": [37, 45, 53, 61], "length": 4, "is_unclued": false, "possible_solutions": [5890, 3844, 5766, 5642, 9610, 3596, 1550, 5394, 1302, 5270, 8990, 8866, 2852, 4774, 9982, 2356, 4278, 8246, 2108, 4030, 1612, 3534, 7502, 3410, 7378, 1364, 3162, 7130, 3038, 2418, 2170, 2046], "original_solution_count": 32}, "17_DOWN": {"number": 17, "direction": "DOWN", "cell_indices": [39, 47, 55, 63], "length": 4, "is_unclued": false, "possible_solutions": [2401], "original_solution_count": 1}, "18_ACROSS": {"number": 18, "direction": "ACROSS", "cell_indices": [40, 41, 42, 43], "length": 4, "is_unclued": false, "possible_solutions": [1024], "original_solution_count": 1}, "19_ACROSS": {"number": 19, "direction": "ACROSS", "cell_indices": [44, 45, 46, 47], "length": 4, "is_unclued": false, "possible_solutions": [8712, 6160, 9240, 1056, 2464, 3872, 5544, 9900, 1584, 4400, 5808, 8624, 5940, 2376, 6600, 8910, 2640, 9680, 1760, 5346, 3564, 3696, 3960, 8316], "original_solution_count": 24}, "20_ACROSS": {"number": 20, "direction": "ACROSS", "cell_indices": [48, 49], "length": 2, "is_unclued": false, "possible_solutions": [32], "original_solution_count": 1}, "21_DOWN": {"number": 21, "direction": "DOWN", "cell_indices": [54, 62], "length": 2, "is_unclued": false, "possible_solutions": [16, 81], "original_solution_count": 2}, "22_ACROSS": {"number": 22, "direction": "ACROSS", "cell_indices": [56, 57, 58, 59], "length": 4, "is_unclued": false, "possible_solutions": [2858], "original_solution_count": 1}, "23_ACROSS": {"number": 23, "direction": "ACROSS", "cell_indices": [60, 61, 62, 63], "length": 4, "is_unclued": false, "possible_solutions": [3969, 7875, 1701, 9261, 2835, 4725, 6615], "original_solution_count": 7}};
        
        // Track user-selected solutions vs algorithm-determined solutions
        let userSelectedSolutions = new Set();
        let originalSolutionCounts = {};
        let originalSolutions = {};
        
        // Initialize original solution counts and store original solutions
        for (const [clueId, clue] of Object.entries(clueObjects)) {
            originalSolutionCounts[clueId] = clue.possible_solutions.length;
            originalSolutions[clueId] = [...clue.possible_solutions]; // Store original solutions
        }
        
        // Undo system
        let solutionHistory = [];
        let undoButton = null;
        let historyInfo = null;
        
        // Function to save current state
        function saveState(clueId, solution) {
            const state = {
                timestamp: new Date().toLocaleTimeString(),
                clueId: clueId,
                solution: solution,
                solvedCells: {...solvedCells},
                clueObjects: JSON.parse(JSON.stringify(clueObjects)), // Deep copy
                userSelectedSolutions: new Set(userSelectedSolutions) // Copy the set
            };
            solutionHistory.push(state);
            updateUndoButton();
            console.log('Saved state:', state);
        }
        
        // Function to restore previous state
        function undoLastSolution() {
            if (solutionHistory.length === 0) return;
            
            const lastState = solutionHistory.pop();
            console.log('Undoing solution:', lastState);
            
            // Restore solved cells
            solvedCells = {...lastState.solvedCells};
            
            // Restore clue objects
            clueObjects = JSON.parse(JSON.stringify(lastState.clueObjects));
            
            // Restore user-selected solutions
            userSelectedSolutions = new Set(lastState.userSelectedSolutions);
            
            // Update grid display
            updateGridDisplay();
            
            // Update all clue displays
            updateAllClueDisplays();
            
            // Update progress
            updateProgress();
            
            // Update undo button
            updateUndoButton();
            
            // Show notification based on action type
            if (lastState.solution === 'DESELECT') {
                showNotification(`Undid deselect for clue ${lastState.clueId}`, 'info');
            } else {
                showNotification(`Undid solution "${lastState.solution}" for clue ${lastState.clueId}`, 'info');
            }
        }
        
        // Function to update undo button state
        function updateUndoButton() {
            if (!undoButton) return;
            
            const canUndo = solutionHistory.length > 0;
            undoButton.disabled = !canUndo;
            
            if (canUndo) {
                const lastState = solutionHistory[solutionHistory.length - 1];
                if (lastState.solution === 'DESELECT') {
                    historyInfo.textContent = `Last action: Deselected clue ${lastState.clueId} at ${lastState.timestamp}`;
                } else {
                    historyInfo.textContent = `Last solution: ${lastState.solution} for ${lastState.clueId} at ${lastState.timestamp}`;
                }
            } else {
                historyInfo.textContent = 'No solutions applied yet';
            }
        }
        
        // Function to update grid display from solvedCells
        function updateGridDisplay() {
            // Clear all cell values first
            document.querySelectorAll('.cell-value').forEach(el => {
                el.remove();
            });
            
            // Update cells that have values
            for (const [cellIndex, digit] of Object.entries(solvedCells)) {
                updateCellDisplay(parseInt(cellIndex), digit);
            }
        }

        // Attach event listeners after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up event listeners');
            
            // Initialize undo system
            undoButton = document.getElementById('undo-button');
            historyInfo = document.getElementById('history-info');
            updateUndoButton();
            
            // Add undo button event listener
            undoButton.addEventListener('click', undoLastSolution);
            
            // Event delegation for clue clicks
            document.querySelector('.clues-section').addEventListener('click', function(e) {
                const clueDiv = e.target.closest('.clue');
                if (!clueDiv) return;
                
                // Don't toggle if clicking on the dropdown or input itself
                if (e.target.closest('.solution-dropdown') || e.target.closest('.solution-input') || e.target.closest('.deselect-dialog') || e.target.classList.contains('apply-solution') || e.target.classList.contains('deselect-solution')) {
                    return;
                }
                
                const clueId = clueDiv.getAttribute('data-clue');
                console.log('Clue clicked:', clueId);
                
                // Check if this clue has a user-selected solution
                if (userSelectedSolutions.has(clueId)) {
                    // Show deselect dialog instead of dropdown
                    showDeselectDialog(clueId);
                    return;
                }
                
                const dropdown = document.getElementById(`dropdown-${clueId}`);
                const input = document.getElementById(`input-${clueId}`);
                
                // Hide all other dropdowns and inputs
                document.querySelectorAll('.solution-dropdown, .solution-input, .deselect-dialog').forEach(d => {
                    if (d !== dropdown && d !== input) d.style.display = 'none';
                });
                
                // Toggle this dropdown/input
                if (dropdown) {
                    const isHidden = dropdown.style.display === 'none' || dropdown.style.display === '';
                    dropdown.style.display = isHidden ? 'block' : 'none';
                    console.log('Toggled dropdown for', clueId, 'to', isHidden ? 'visible' : 'hidden');
                } else if (input) {
                    const isHidden = input.style.display === 'none' || input.style.display === '';
                    input.style.display = isHidden ? 'block' : 'none';
                    console.log('Toggled input for', clueId, 'to', isHidden ? 'visible' : 'hidden');
                }
            });

            // Handle solution selection and application using event delegation
            document.querySelector('.clues-section').addEventListener('click', function(e) {
                if (e.target.classList.contains('apply-solution')) {
                    e.stopPropagation(); // Prevent bubbling to clue click
                    const clueId = e.target.getAttribute('data-clue');
                    console.log('Apply button clicked for:', clueId);
                    
                    const select = e.target.parentNode.querySelector('.solution-select');
                    const input = e.target.parentNode.querySelector('.solution-text-input');
                    
                    let solution = '';
                    if (select) {
                        solution = select.value;
                        console.log('Selected solution from dropdown:', solution);
                    } else if (input) {
                        solution = input.value;
                        console.log('Entered solution from input:', solution);
                    }
                    
                    if (solution) {
                        applySolutionToGrid(clueId, solution);
                    } else {
                        showNotification('Please select or enter a solution first', 'error');
                    }
                }
            });
        });

        function updateCellDisplay(cellIndex, digit) {
            const cell = document.querySelector(`[data-cell="${cellIndex}"]`);
            if (cell) {
                let valueElement = cell.querySelector('.cell-value');
                if (!valueElement) {
                    // Create the cell-value element if it doesn't exist
                    valueElement = document.createElement('div');
                    valueElement.className = 'cell-value';
                    cell.appendChild(valueElement);
                }
                valueElement.textContent = digit;
            }
        }

        function applySolutionToGrid(clueId, solution) {
            console.log(`Applying solution "${solution}" to clue ${clueId}`);
            
            // Save current state before applying solution
            saveState(clueId, solution);
            
            // Parse clue ID to get number and direction
            const [number, direction] = clueId.split('_');
            const clueNumber = parseInt(number);
            
            // Validate solution format
            if (!/^\d+$/.test(solution)) {
                showNotification('Solution must be a number', 'error');
                return;
            }
            
            // Get clue object
            const clue = clueObjects[clueId];
            if (!clue) {
                showNotification('Clue not found', 'error');
                return;
            }
            
            // Validate solution length
            if (solution.length !== clue.length) {
                showNotification(`Solution must be ${clue.length} digits long`, 'error');
                return;
            }
            
            // For unclued clues, check if the solution conflicts with already solved crossing clues
            if (clue.is_unclued) {
                const solutionStr = solution.padStart(clue.length, '0');
                const conflicts = [];
                
                // Check each cell position against already solved cells
                for (let i = 0; i < clue.cell_indices.length; i++) {
                    const cellIndex = clue.cell_indices[i];
                    const digit = parseInt(solutionStr[i]);
                    
                    // If this cell is already solved, check if it conflicts
                    if (cellIndex in solvedCells) {
                        if (solvedCells[cellIndex] !== digit) {
                            // Find which clue this cell belongs to for better error message
                            let conflictingClue = '';
                            for (const [otherClueId, otherClue] of Object.entries(clueObjects)) {
                                if (otherClue.cell_indices.includes(cellIndex)) {
                                    conflictingClue = otherClueId;
                                    break;
                                }
                            }
                            conflicts.push(`Cell ${cellIndex} (clue ${conflictingClue}) already has value ${solvedCells[cellIndex]}, but your solution has ${digit}`);
                        }
                    }
                }
                
                if (conflicts.length > 0) {
                    const errorMsg = `Solution conflicts with existing values:\n${conflicts.join('\n')}`;
                    showNotification(errorMsg, 'error');
                    
                    // Show error in the unclued clue's error span
                    const errorSpan = document.getElementById(`error-${clueId}`);
                    if (errorSpan) {
                        errorSpan.textContent = 'Conflicts with existing solutions';
                        errorSpan.style.display = 'inline';
                    }
                    return;
                }
                
                // Clear any previous error
                const errorSpan = document.getElementById(`error-${clueId}`);
                if (errorSpan) {
                    errorSpan.style.display = 'none';
                }
            } else {
                // For regular clues, check if solution is valid for this clue
                if (!clue.possible_solutions.includes(parseInt(solution))) {
                    showNotification('This solution is not valid for this clue', 'error');
                    return;
                }
            }
            
            // Apply solution to grid cells
            const solutionStr = solution.padStart(clue.length, '0');
            for (let i = 0; i < clue.cell_indices.length; i++) {
                const cellIndex = clue.cell_indices[i];
                const digit = parseInt(solutionStr[i]);
                solvedCells[cellIndex] = digit;
                
                // Update grid display
                updateCellDisplay(cellIndex, digit);
            }
            
            // Mark clue as solved
            clue.possible_solutions = [parseInt(solution)];
            
            // Mark this as a user-selected solution
            userSelectedSolutions.add(clueId);
            
            // Propagate constraints to crossing clues
            const eliminatedSolutions = propagateConstraints(clueId, solution);
            
            // Update all clue displays
            updateAllClueDisplays();
            
            // Update progress
            updateProgress();
            
            // Show success message
            const eliminatedCount = eliminatedSolutions.length;
            if (eliminatedCount > 0) {
                showNotification(`Solution applied! Eliminated ${eliminatedCount} incompatible solutions from crossing clues.`, 'success');
            } else {
                showNotification('Solution applied successfully!', 'success');
            }
            
            // Hide the dropdown/input
            const dropdown = document.getElementById(`dropdown-${clueId}`);
            const input = document.getElementById(`input-${clueId}`);
            if (dropdown) dropdown.style.display = 'none';
            if (input) input.style.display = 'none';
        }

        function propagateConstraints(clueId, solution) {
            const eliminatedSolutions = [];
            const clue = clueObjects[clueId];
            const solutionStr = solution.padStart(clue.length, '0');
            
            // Find all clues that share cells with this clue
            const crossingClues = [];
            for (const [otherClueId, otherClue] of Object.entries(clueObjects)) {
                if (otherClueId !== clueId) {
                    // Check if any cells overlap
                    const overlap = clue.cell_indices.filter(cell => 
                        otherClue.cell_indices.includes(cell)
                    );
                    if (overlap.length > 0) {
                        crossingClues.push(otherClueId);
                    }
                }
            }
            
            // Eliminate incompatible solutions from crossing clues
            for (const crossingClueId of crossingClues) {
                const crossingClue = clueObjects[crossingClueId];
                const solutionsToRemove = [];
                
                for (const possibleSolution of crossingClue.possible_solutions) {
                    const possibleStr = possibleSolution.toString().padStart(crossingClue.length, '0');
                    let incompatible = false;
                    
                    // Check each cell position
                    for (let i = 0; i < crossingClue.cell_indices.length; i++) {
                        const cellIndex = crossingClue.cell_indices[i];
                        const digit = parseInt(possibleStr[i]);
                        
                        // If this cell is already solved, check compatibility
                        if (cellIndex in solvedCells) {
                            if (solvedCells[cellIndex] !== digit) {
                                incompatible = true;
                                break;
                            }
                        }
                    }
                    
                    if (incompatible) {
                        solutionsToRemove.push(possibleSolution);
                    }
                }
                
                // Remove incompatible solutions
                for (const solutionToRemove of solutionsToRemove) {
                    crossingClue.possible_solutions = crossingClue.possible_solutions.filter(s => s !== solutionToRemove);
                    eliminatedSolutions.push({clueId: crossingClueId, solution: solutionToRemove});
                }
            }
            
            return eliminatedSolutions;
        }

        function updateAllClueDisplays() {
            // Update each clue's display based on current state
            for (const [clueId, clue] of Object.entries(clueObjects)) {
                updateClueDisplay(clueId, clue);
            }
        }

        function updateClueDisplay(clueId, clue) {
            const clueElement = document.querySelector(`[data-clue="${clueId}"]`);
            if (!clueElement) return;
            
            // Update solution count - show actual remaining solutions, not just "1" if user selected
            const countElement = clueElement.querySelector('.solution-count');
            if (countElement) {
                countElement.textContent = `${clue.possible_solutions.length} solutions`;
            }
            
            // Update clue styling based on solution count and user selection
            clueElement.className = 'clue';
            
            if (clue.possible_solutions.length === 1) {
                if (userSelectedSolutions.has(clueId)) {
                    // User manually selected this solution
                    clueElement.classList.add('user-selected');
                } else {
                    // Algorithm determined only one solution remains
                    clueElement.classList.add('algorithm-solved');
                }
            } else if (clue.possible_solutions.length > 1) {
                if (userSelectedSolutions.has(clueId)) {
                    // User selected a solution but there are still other possibilities
                    clueElement.classList.add('user-selected');
                } else {
                    // Multiple solutions available, no user selection
                    clueElement.classList.add('multiple');
                }
            } else if (clue.is_unclued) {
                clueElement.classList.add('unclued');
            }
            
            // Update dropdown options if it exists
            const dropdown = document.getElementById(`dropdown-${clueId}`);
            if (dropdown) {
                const select = dropdown.querySelector('.solution-select');
                if (select) {
                    // Keep the first option (placeholder) and update only the solution options
                    const placeholderOption = select.querySelector('option[value=""]');
                    select.innerHTML = '';
                    
                    // Restore the placeholder option
                    if (placeholderOption) {
                        select.appendChild(placeholderOption);
                    } else {
                        const newPlaceholder = document.createElement('option');
                        newPlaceholder.value = '';
                        newPlaceholder.textContent = '-- Select a solution --';
                        select.appendChild(newPlaceholder);
                    }
                    
                    // Add the solution options
                    for (const solution of clue.possible_solutions) {
                        const option = document.createElement('option');
                        option.value = solution;
                        option.textContent = solution.toString().padStart(clue.length, '0');
                        select.appendChild(option);
                    }
                    
                    console.log(`Updated dropdown for ${clueId} with ${clue.possible_solutions.length} solutions`);
                }
            }
        }

        function updateProgress() {
            const filledCells = Object.keys(solvedCells).length;
            const percentage = (filledCells / 64) * 100;
            
            // Count solved clues (both user-selected and algorithm-determined)
            let solvedClues = 0;
            for (const clue of Object.values(clueObjects)) {
                if (clue.possible_solutions.length === 1) {
                    solvedClues++;
                }
            }
            
            document.querySelector('.progress-fill').style.width = percentage + '%';
            document.querySelector('.progress-stats').innerHTML = 
                `<div>Cells filled: ${filledCells}/64 (${percentage.toFixed(1)}%)</div>
                 <div>Clues solved: ${solvedClues}/24</div>`;
        }

        function showNotification(message, type) {
            // Remove existing notifications
            const existing = document.querySelector('.notification');
            if (existing) {
                existing.remove();
            }
            
            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // Append to main-content instead of body
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.appendChild(notification);
            } else {
                document.body.appendChild(notification);
            }
            
            // Show notification
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 10);
            
            // Hide notification after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        function showDeselectDialog(clueId) {
            // Hide any existing dialogs
            document.querySelectorAll('.solution-dropdown, .solution-input, .deselect-dialog').forEach(d => {
                d.style.display = 'none';
            });
            
            const clue = clueObjects[clueId];
            const currentSolution = clue.possible_solutions[0];
            const solutionStr = currentSolution.toString().padStart(clue.length, '0');
            
            // Create deselect dialog
            const dialog = document.createElement('div');
            dialog.className = 'deselect-dialog';
            dialog.id = `deselect-${clueId}`;
            dialog.style.cssText = `
                margin-top: 8px;
                padding: 12px;
                background-color: #fff3cd;
                border: 1px solid #ffeaa7;
                border-radius: 4px;
                border-left: 4px solid #f39c12;
            `;
            
            dialog.innerHTML = `
                <div style="margin-bottom: 8px; font-weight: bold; color: #856404;">
                    Current solution: <span style="font-family: monospace;">${solutionStr}</span>
                </div>
                <div style="margin-bottom: 12px; color: #856404;">
                    Click "Deselect" to remove this solution and restore all possible solutions for this clue.
                </div>
                <button class="deselect-solution" data-clue="${clueId}" style="
                    background-color: #dc3545;
                    color: white;
                    border: none;
                    padding: 6px 12px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                    margin-right: 8px;
                ">Deselect Solution</button>
                <button class="cancel-deselect" style="
                    background-color: #6c757d;
                    color: white;
                    border: none;
                    padding: 6px 12px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                ">Cancel</button>
            `;
            
            // Find the clue element and append the dialog
            const clueElement = document.querySelector(`[data-clue="${clueId}"]`);
            if (clueElement) {
                clueElement.appendChild(dialog);
                
                // Add event listeners
                dialog.querySelector('.deselect-solution').addEventListener('click', function(e) {
                    e.stopPropagation();
                    deselectSolution(clueId);
                });
                
                dialog.querySelector('.cancel-deselect').addEventListener('click', function(e) {
                    e.stopPropagation();
                    dialog.style.display = 'none';
                });
            }
        }

        function deselectSolution(clueId) {
            console.log(`Deselecting solution for clue ${clueId}`);
            
            // Save current state before deselecting
            saveState(clueId, 'DESELECT');
            
            const clue = clueObjects[clueId];
            const currentSolution = clue.possible_solutions[0];
            
            // Remove the solution from the grid cells
            const solutionStr = currentSolution.toString().padStart(clue.length, '0');
            for (let i = 0; i < clue.cell_indices.length; i++) {
                const cellIndex = clue.cell_indices[i];
                
                // Check if this cell is used by other user-selected clues
                let canRemoveCell = true;
                for (const [otherClueId, otherClue] of Object.entries(clueObjects)) {
                    if (otherClueId !== clueId && userSelectedSolutions.has(otherClueId)) {
                        if (otherClue.cell_indices.includes(cellIndex)) {
                            canRemoveCell = false;
                            break;
                        }
                    }
                }
                
                if (canRemoveCell) {
                    delete solvedCells[cellIndex];
                    
                    // Clear the cell display
                    const cell = document.querySelector(`[data-cell="${cellIndex}"]`);
                    if (cell) {
                        const valueElement = cell.querySelector('.cell-value');
                        if (valueElement) {
                            valueElement.remove();
                        }
                    }
                }
            }
            
            // Remove from user-selected solutions BEFORE recalculating constraints
            userSelectedSolutions.delete(clueId);
            
            // Explicitly restore original solutions for the deselected clue
            const originalCount = clue.original_solution_count || 0;
            console.log(`Restoring original solutions for ${clueId}: original count = ${originalCount}`);
            
            // Restore from stored original solutions
            if (originalSolutions[clueId]) {
                clue.possible_solutions = [...originalSolutions[clueId]]; // Deep copy
                console.log(`Restored original solutions for ${clueId}:`, originalSolutions[clueId]);
            } else {
                console.log(`No original solutions found for ${clueId}`);
                clue.possible_solutions = [];
            }
            
            // Recalculate constraints for all OTHER clues (not the deselected one)
            recalculateAllConstraintsExcept(clueId);
            
            // Update all clue displays
            updateAllClueDisplays();
            
            // Update progress
            updateProgress();
            
            // Hide the deselect dialog
            const dialog = document.getElementById(`deselect-${clueId}`);
            if (dialog) {
                dialog.style.display = 'none';
            }
            
            // Show success message
            const restoredCount = clue.possible_solutions.length;
            showNotification(`Deselected solution for clue ${clueId}. Restored ${restoredCount} possible solutions.`, 'success');
        }

        function recalculateAllConstraintsExcept(excludeClueId) {
            // Recalculate constraints based on current solved cells, excluding the specified clue
            for (const [clueId, clue] of Object.entries(clueObjects)) {
                // Skip the excluded clue and clues that have user-selected solutions
                if (clueId === excludeClueId || userSelectedSolutions.has(clueId)) continue;
                
                // Get original solutions for this clue from our stored original solutions
                const clueOriginalSolutions = originalSolutions[clueId] || [];
                const validSolutions = [];
                
                // Check each original solution against current grid state
                for (const solution of clueOriginalSolutions) {
                    const solutionInt = parseInt(solution);
                    const solutionStr = solutionInt.toString().padStart(clue.length, '0');
                    let isValid = true;
                    
                    // Check each cell position
                    for (let i = 0; i < clue.cell_indices.length; i++) {
                        const cellIndex = clue.cell_indices[i];
                        const digit = parseInt(solutionStr[i]);
                        
                        // If this cell is already solved, check compatibility
                        if (cellIndex in solvedCells) {
                            if (solvedCells[cellIndex] !== digit) {
                                isValid = false;
                                break;
                            }
                        }
                    }
                    
                    if (isValid) {
                        validSolutions.push(solutionInt);
                    }
                }
                
                // Update the clue's possible solutions
                clue.possible_solutions = validSolutions;
            }
        }

        function recalculateAllConstraints() {
            // Recalculate constraints for all clues (used for undo operations)
            for (const [clueId, clue] of Object.entries(clueObjects)) {
                // Skip clues that have user-selected solutions
                if (userSelectedSolutions.has(clueId)) continue;
                
                // Get original solutions for this clue from our stored original solutions
                const clueOriginalSolutions = originalSolutions[clueId] || [];
                const validSolutions = [];
                
                // Check each original solution against current grid state
                for (const solution of clueOriginalSolutions) {
                    const solutionInt = parseInt(solution);
                    const solutionStr = solutionInt.toString().padStart(clue.length, '0');
                    let isValid = true;
                    
                    // Check each cell position
                    for (let i = 0; i < clue.cell_indices.length; i++) {
                        const cellIndex = clue.cell_indices[i];
                        const digit = parseInt(solutionStr[i]);
                        
                        // If this cell is already solved, check compatibility
                        if (cellIndex in solvedCells) {
                            if (solvedCells[cellIndex] !== digit) {
                                isValid = false;
                                break;
                            }
                        }
                    }
                    
                    if (isValid) {
                        validSolutions.push(solutionInt);
                    }
                }
                
                // Update the clue's possible solutions
                clue.possible_solutions = validSolutions;
            }
        }
    </script>
</body>
</html>